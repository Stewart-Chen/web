<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>教學團隊｜HeartHub Studio 心聚坊</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 樣式與字型（全站一致） -->
  <link rel="icon" href="img/logo.png" sizes="16x16" type="image/png">
  <link rel="stylesheet" href="css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800&family=Noto+Serif+TC:wght@600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet" />

  <!-- JS：外部/共用/應用 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/shared-dialog.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script defer src="js/app.js"></script>
</head>
<body>
  <!-- shared-layout.js 會自動插入 header/footer -->

  <main class="container">
    <!-- Hero -->
    <section class="hero card hero-card">
      <div class="hero-content">
        <h2>教學團隊</h2>
        <p class="muted">認識我們的園藝與藝術治療師與講師們，了解他們的專長與課程風格。</p>
      </div>
    </section>

    <!-- 搜尋 / 標籤過濾（可選） -->
    <section class="card key-bar">
      <form id="teacher-filters" class="form-grid">
        <label>
          <input type="search" id="q" placeholder="輸入姓名、專長、關鍵字…" />
        </label>
        <div>
          <button type="submit" class="btn primary" style="display:none;">搜尋</button>
        </div>
      </form>
    </section>

    <!-- 師資清單 -->
    <section class="teachers">
      <h3 class="muted count" id="count">載入中…</h3>
      <div id="teacher-grid" class="teacher-grid" aria-live="polite" aria-busy="true"></div>
      <p id="empty" class="muted hidden">目前沒有可顯示的師資。</p>
    </section>
  </main>

  <!-- 頁面專用腳本：載入與渲染 -->
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const sb    = window.sb; // ← 重要：取用 shared-layout.js 初始化好的 Supabase client
    const grid  = document.getElementById('teacher-grid');
    const empty = document.getElementById('empty');
    const count = document.getElementById('count');
    const q     = document.getElementById('q');
    const form  = document.getElementById('teacher-filters');

    // 安全防呆
    if (!sb || typeof sb.from !== 'function') {
      console.warn('Supabase 尚未初始化');
      empty.classList.remove('hidden');
      count.textContent = '0 位師資';
      return;
    }

    // 取得師資資料（新版欄位）
    async function fetchTeachers() {
      try {
        const { data, error } = await sb
          .from('teachers')
          .select('id,name,category,summary,description,cover_url,created_at')
          .order('name', { ascending: true });
        if (error) throw error;
        return data || [];
      } catch (err) {
        console.error('[teachers] load error:', err);
        return [];
      }
    }

    function escapeHtml(s){
      return String(s || '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[m]);
    }

    function badge(txt){ return `<span class="badge plan-type">${escapeHtml(txt)}</span>`; }

    function coverFor(t){
      if (t.cover_url) return t.cover_url;
      if (t.name === '汎汎') return '/web/img/fan.jpg';
      if (t.name === '小D')  return '/web/img/dd.jpg';
      return `https://picsum.photos/seed/teacher-${encodeURIComponent(t.id || t.name)}/640/360`;
    }

    // 產生卡片（沿用你的視覺語言，用 course-card 樣式看起來更一致）
function renderCard(t) {
  const cats = Array.isArray(t.category) ? t.category.filter(Boolean)
            : (t.category ? [t.category] : []);
  const catBadges = cats.map(c => badge(c)).join(' ');

  const html = `
    <article class="course-card card">
      <div class="carousel">
        <div class="track">
          <div class="slide">
            <img src="${coverFor(t)}" alt="${escapeHtml(t.name)}" loading="lazy" width="640" height="360">
          </div>
        </div>
      </div>
      <div class="course-body">
        <div class="title-row">
          <h3>${escapeHtml(t.name)}</h3>
          ${catBadges}
        </div>
        <p class="muted">${escapeHtml(t.summary || '—')}</p>
        <div class="meta-row" style="gap:8px;flex-wrap:wrap;">
          <a class="btn secondary" href="teacher.html?id=${t.id}">查看介紹</a>
          <a class="btn" href="courses.html" data-teacher="${escapeHtml(t.name)}">相關課程</a>
        </div>
      </div>
    </article>
  `;

  // 這裡包在 <a> 外層，並確保 innerHTML 塞入
  const link = document.createElement('a');
  link.href = `teacher.html?id=${t.id}`;
  link.className = 'course-link';
  link.innerHTML = html;

  // 幫「相關課程」按鈕綁定事件
  const btn = link.querySelector('a.btn[data-teacher]');
  if (btn) {
    btn.addEventListener('click', (e) => {
      const nextState = {
        page: 1,
        teacher: btn.dataset.teacher,
        category: null,
        plan_type: null,
        keyword: null,
        q: ''
      };
      try { sessionStorage.setItem('courseState', JSON.stringify(nextState)); } catch {}
    });
  }

  return link;
}


    function renderList(list){
      grid.innerHTML = '';
      grid.setAttribute('aria-busy', 'true');

      if (!list.length) {
        empty.classList.remove('hidden');
        count.textContent = '0 位師資';
        grid.setAttribute('aria-busy', 'false');
        return;
      }
      empty.classList.add('hidden');

      const frag = document.createDocumentFragment();
      list.forEach(t => frag.appendChild(renderCard(t)));
      grid.appendChild(frag);

      count.textContent = `${list.length} 位師資`;
      grid.setAttribute('aria-busy', 'false');
    }

    // 初次載入
    const ALL = await fetchTeachers();
    renderList(ALL);

    // 關鍵字過濾（支援：姓名 / summary / description / category）
    function filterNow(){
      const keyword = (q.value || '').trim().toLowerCase();
      if (!keyword) return renderList(ALL);
      const filtered = ALL.filter(t => {
        const cats = Array.isArray(t.category) ? t.category.join(' ') : (t.category || '');
        const hay = [
          t.name, t.summary, t.description, cats
        ].join(' ').toLowerCase();
        return hay.includes(keyword);
      });
      renderList(filtered);
    }

    form?.addEventListener('submit', e => { e.preventDefault(); filterNow(); });
    q?.addEventListener('input', () => { filterNow(); });
  });
</script>

</body>
</html>

