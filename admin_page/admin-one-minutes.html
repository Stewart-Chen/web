<!doctype html>
<html lang="zh-Hant" data-guard="checking">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>量表編輯｜HeartHub Studio 心聚坊</title>

  <!-- 字型與樣式 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="stylesheet" href="../css/admin.css" />

  <!-- SDK / 共用腳本 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="../js/shared-layout.js"></script>
  <script defer src="../js/admin_js/admin-guard.js"></script>
  <script defer src="../js/admin_js/admin-one-minutes.js"></script>
  <script defer src="../js/app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
  <!-- 若缺 QRCode，提供 no-op 容錯 -->
  <script>
    if (typeof window.QRCode === 'undefined') {
      window.QRCode = function(){}; window.QRCode.CorrectLevel = {L:1,M:2,Q:3,H:4};
    }
  </script>

  <main class="container page-admin">
    <section class="admin-wrap">
      <!-- 左欄：產生表單連結與 QR -->
      <div class="admin-card">
        <h3 style="margin:0;">A. 心聚 1 分鐘表單連結 / QR</h3>
        <p class="muted" style="margin-top:6px;">
          同一支 <code class="mono">one-minute.html</code>，以 <code class="mono">tp=pre|post|72h</code> 切換課前/課後/72h。
          先選擇「現有課程」或手動輸入 id，再按「重新整理」。
        </p>

        <!-- 檔名偵測結果徽章 -->
        <p id="form-detect-badge" class="muted"></p>

        <div class="grid2" style="margin-top:10px;">
          <label>選擇課程（最近 50 筆）
            <select id="course-select">
              <option value="">— 請選擇課程 —</option>
            </select>
          </label>

          <label>或手動輸入課程 ID
            <input id="course-input" type="number" placeholder="例如 55" />
          </label>

          <label>場次編號（session，可空）
            <input id="session-input" type="number" placeholder="例如 101" />
          </label>

          <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
            <button id="btn-refresh" class="btn">重新整理連結與 QR</button>
          </div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <a id="btn-pre"  class="btn">課前表單</a>
          <a id="btn-post" class="btn secondary">課後表單</a>
          <a id="btn-72h"  class="btn outline">72 小時追蹤</a>
        </div>

        <div class="grid3" style="margin-top:12px;">
          <div>
            <div id="qr-pre"></div>
            <p id="url-pre"  class="muted wrap mono">—</p>
            <button class="btn copy" data-copy="#url-pre">複製連結</button>
          </div>
          <div>
            <div id="qr-post"></div>
            <p id="url-post" class="muted wrap mono">—</p>
            <button class="btn copy" data-copy="#url-post">複製連結</button>
          </div>
          <div>
            <div id="qr-72h"></div>
            <p id="url-72h" class="muted wrap mono">—</p>
            <button class="btn copy" data-copy="#url-72h">複製連結</button>
          </div>
        </div>

        <p class="muted" style="margin-top:8px;">
          <small>提示：若 <code class="mono">course</code> 留空，連結仍可開啟頁面，但若 <code class="mono">one_minute.course_id</code> 設有外鍵，寫入會失敗。建議總是帶入存在的課程 id。</small>
        </p>
      </div>

      <!-- 右欄：測試課程工具 -->
      <div class="admin-card">
        <h3 style="margin:0;">B. 測試課程工具（僅管理員）</h3>
        <p class="muted" style="margin-top:6px;">
          快速建立一筆【測試】課程（category：<span class="mono">horti</span>），或查詢／清除。
          需要 RLS 允許目前登入者可對 <code class="mono">public.courses</code> 進行 <em>insert/delete/select</em>。
        </p>

        <div class="actions" style="margin-top:8px;">
          <button id="btn-create-course" class="btn">建立測試課程</button>
          <button id="btn-list-course" class="btn secondary">查詢測試課程</button>
          <button id="btn-clear-course" class="btn danger">清除測試課程</button>
        </div>

        <pre id="admin-log" class="mono" style="white-space:pre-wrap; background:#f6f8fa; padding:12px; border-radius:8px; margin-top:10px; max-height:320px; overflow:auto;">（操作結果會顯示在這裡）</pre>
      </div>
    </section>
  </main>
</body>
</html>
