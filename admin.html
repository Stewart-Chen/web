<!doctype html>
<html lang="zh-Hant" data-guard="checking">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>課程管理｜HeartHub Studio 心聚坊</title>

  <!-- 你的主樣式（請保留） -->
  <link rel="stylesheet" href="css/styles.css" />

  <!-- Admin 頁面在身分檢查期間先隱藏 main，通過後再顯示，避免閃屏 -->
  <style>
    html[data-guard="checking"] main { visibility: hidden; }
    main.page-admin { padding-top: 14px; padding-bottom: 32px; }
    .admin-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 12px;
    }
    .admin-header {
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      margin-top: 6px;
    }
    .admin-tools { display:flex; gap:8px; flex-wrap:wrap; }
    .admin-col { min-width: 0; } /* 防止內容溢出 */
    .admin-card { padding:16px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; box-shadow: var(--shadow-sm); }

    /* 列表 item（沿用你站內風格） */
    #admin-courses .item, #admin-lessons .item{
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 10px; border:1px solid #e6e6e6; border-radius:8px; margin-bottom:8px; background:#fff;
    }
    #admin-courses, #admin-lessons { max-height: 360px; overflow: auto; }

    /* RWD：手機改為單欄堆疊 */
    @media (max-width: 900px){
      .admin-wrap { grid-template-columns: 1fr; }
    }
  </style>

  <!-- Supabase JS（若你的專案已有可移除這行；否則保留） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- 先建立 Supabase client，供守門與本頁使用 -->
  <script>
    window.SUPABASE_URL = "https://ilhmywiktdqilmaisbyp.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsaG15d2lrdGRxaWxtYWlzYnlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTczODcsImV4cCI6MjA3MTIzMzM4N30.qCpu7NhwaEkmyFJmg9MB6MrkcqmPiywGV2c_U3U9h4c";
    window.supabase = window.supabase || supabase; // 防止重複定義
    window.sb = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  </script>

  <!-- 頁面守門：非登入/非管理者一律導回首頁 -->
  <script>
    async function guardAdminPage() {
      try {
        // 1) 要登入
        const { data: userData } = await sb.auth.getUser();
        const user = userData?.user;
        if (!user) {
          location.replace('index.html?need_login=1');
          return;
        }
        // 2) 要在 admins 表
        const { data, error } = await sb
          .from('admins')
          .select('user_id')
          .eq('user_id', user.id)
          .maybeSingle();

        if (error || !data) {
          location.replace('index.html');
          return;
        }
        // 通過 → 顯示內容
        document.documentElement.removeAttribute('data-guard');
      } catch (err) {
        console.error('guard error:', err);
        location.replace('index.html');
      }
    }
    guardAdminPage();
  </script>
</head>
<body>

  <!-- 共用頁首/頁尾（請確保檔案存在） -->
  <script src="js/shared-layout.js"></script>
  <!-- 需要登入對話框（auth-modal 等） -->
  <script src="js/shared-dialog.js"></script>

  <main class="container page-admin">
    <h2 class="fancy-title" style="margin-top:10px;">管理面板</h2>

    <section class="admin-wrap">

      <!-- 左欄：課程清單 -->
      <div class="admin-col">
        <div class="admin-card">
          <header class="admin-header">
            <h3 style="margin:0;">課程清單</h3>
            <div class="admin-tools">
              <button type="button" class="btn" id="admin-refresh">重新整理</button>
              <button type="button" class="btn primary" id="admin-new-course">＋ 新增課程</button>
            </div>
          </header>

          <div id="admin-courses" style="margin-top:10px;">
            <!-- JS 產生清單 -->
          </div>
        </div>
      </div>

      <!-- 右欄：課程內容 + 單元 -->
      <div class="admin-col">
        <div class="admin-card">
          <h3 style="margin:0;">課程內容</h3>
          <form id="admin-course-form" class="form-grid" style="margin-top:12px;">
            <input type="hidden" id="ac-id" />
            <label>標題 <input id="ac-title" required /></label>
            <label>摘要 <input id="ac-summary" /></label>
            <label>描述 <textarea id="ac-desc" rows="4"></textarea></label>
            <label>封面網址 <input id="ac-cover" placeholder="https://..." /></label>
            <label>授課老師
              <select id="ac-teacher" required>
                <option value="">— 選擇 —</option>
                <option value="fanfan">汎汎（園藝）</option>
                <option value="xd">小D（藝術）</option>
              </select>
            </label>
            <label><input type="checkbox" id="ac-published" /> 已發佈（公開可見）</label>

            <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;">
              <button type="submit" class="btn primary">儲存</button>
              <button type="button" id="admin-soft-delete" class="btn secondary">移到回收（軟刪除）</button>
              <button type="button" id="admin-hard-delete" class="btn danger">永久刪除</button>
            </div>
          </form>
        </div>

        <div class="admin-card" style="margin-top:16px;">
          <h3 style="margin:0;">單元（Lessons）</h3>

          <div id="admin-lessons" style="margin-top:10px;">
            <!-- JS 產生單元清單 -->
          </div>

          <form id="admin-lesson-form" class="form-grid" style="margin-top:12px;">
            <input type="hidden" id="al-id" />
            <label>順序 <input type="number" id="al-order" min="1" value="1" required /></label>
            <label>標題 <input id="al-title" required /></label>
            <label>內容 <textarea id="al-content" rows="3"></textarea></label>
            <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;">
              <button type="submit" class="btn">新增 / 更新單元</button>
              <button type="button" id="admin-lesson-delete" class="btn danger">刪除選取單元</button>
            </div>
          </form>

          <p class="muted" style="margin-top:8px;">＊只有被加入管理者清單的帳號才能操作。</p>
        </div>
      </div>
    </section>
  </main>

  <!-- 共用功能（課程列表、課程頁等） -->
  <script src="js/app.js"></script>

  <!-- 專屬 admin.js：把管理功能集中在本頁（直接內嵌，若你偏好可另存檔） -->
  <script>
    // 使用與 app.js 同一個 supabase client：sb（已在<head>建立）
    let currentUser = null;

    // 取得目前使用者（顯示/隱藏某些按鈕將用得到）
    sb.auth.getUser().then(({ data }) => { currentUser = data?.user ?? null; });

    // 判斷是否為管理者
    async function isAdmin() {
      if (!currentUser) {
        const { data } = await sb.auth.getUser();
        currentUser = data?.user ?? null;
      }
      if (!currentUser) return false;
      const { data, error } = await sb
        .from('admins')
        .select('user_id')
        .eq('user_id', currentUser.id)
        .maybeSingle();
      return !!data && !error;
    }

    // 列表刷新
    async function adminRefresh(){
      const wrap = document.getElementById('admin-courses');
      if (!wrap) return;
      const { data, error } = await sb
        .from('courses')
        .select('id,title,teacher,published,deleted_at,created_at')
        .order('created_at', { ascending: false });
      if (error) { wrap.innerHTML = \`<p class="muted">載入失敗：\${error.message}</p>\`; return; }

      wrap.innerHTML = (data||[]).map(c => \`
        <div class="item" data-id="\${c.id}">
          <div>
            <div class="title">\${c.title}</div>
            <div class="meta">
              <span class="badge">老師：\${c.teacher || '—'}</span>
              <span class="badge">\${c.published ? '已發佈' : '未發佈'}</span>
              \${c.deleted_at ? '<span class="badge">已刪除</span>' : ''}
              <span class="muted">\${new Date(c.created_at).toLocaleString()}</span>
            </div>
          </div>
          <div><button class="btn" data-act="edit">編輯</button></div>
        </div>
      \`).join('');

      wrap.querySelectorAll('[data-act="edit"]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = Number(e.currentTarget.closest('.item').dataset.id);
          const { data: one } = await sb.from('courses').select('*').eq('id', id).maybeSingle();
          adminFillCourseForm(one);
          await adminLoadLessons(one?.id);
        });
      });
    }

    function adminFillCourseForm(c){
      document.getElementById('ac-id').value        = c?.id ?? '';
      document.getElementById('ac-title').value     = c?.title ?? '';
      document.getElementById('ac-summary').value   = c?.summary ?? '';
      document.getElementById('ac-desc').value      = c?.description ?? '';
      document.getElementById('ac-cover').value     = c?.cover_url ?? '';
      document.getElementById('ac-teacher').value   = c?.teacher ?? '';
      document.getElementById('ac-published').checked = !!c?.published;
      const sd = document.getElementById('admin-soft-delete');
      const hd = document.getElementById('admin-hard-delete');
      if (sd) sd.disabled = !c?.id;
      if (hd) hd.disabled = !c?.id;
    }

    async function adminLoadLessons(courseId){
      const box = document.getElementById('admin-lessons');
      if (!courseId) { box.innerHTML = '<p class="muted">先選擇或建立課程。</p>'; return; }
      const { data, error } = await sb
        .from('lessons').select('id,order_no,title,content').eq('course_id', courseId).order('order_no');
      if (error) { box.innerHTML = \`<p class="muted">讀取失敗：\${error.message}</p>\`; return; }

      box.innerHTML = (data||[]).map(l => \`
        <div class="item" data-lid="\${l.id}">
          <div><strong>\${l.order_no}.</strong> \${l.title}</div>
          <div><button class="btn" data-act="edit-lesson">編輯</button></div>
        </div>
      \`).join('');

      box.querySelectorAll('[data-act="edit-lesson"]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const wrap = e.currentTarget.closest('.item');
          const lid = Number(wrap.dataset.lid);
          sb.from('lessons').select('*').eq('id', lid).maybeSingle().then(({data})=>{
            document.getElementById('al-id').value    = lid;
            document.getElementById('al-order').value = data?.order_no ?? 1;
            document.getElementById('al-title').value = data?.title ?? '';
            document.getElementById('al-content').value = data?.content ?? '';
          });
        });
      });
    }

    async function saveCourseFromForm() {
      if (!await isAdmin()) { alert('只有管理者可以操作'); return; }

      const payload = {
        title:   document.getElementById('ac-title').value.trim(),
        summary: document.getElementById('ac-summary').value.trim() || null,
        description: document.getElementById('ac-desc').value.trim() || null,
        cover_url: document.getElementById('ac-cover').value.trim() || null,
        teacher: document.getElementById('ac-teacher').value,
        published: document.getElementById('ac-published').checked,
      };
      const id = Number(document.getElementById('ac-id').value || 0);
      if (!payload.title)   { alert('請填寫標題'); return; }
      if (!payload.teacher) { alert('請選擇授課老師'); return; }

      try {
        if (id) {
          const { error } = await sb.from('courses').update(payload).eq('id', id);
          if (error) throw error;
          alert('課程已更新');
        } else {
          const { error } = await sb.from('courses').insert([payload]);
          if (error) throw error;
          alert('課程已建立');
        }
        await adminRefresh();
      } catch (err) {
        console.error('saveCourse error:', err);
        alert('儲存失敗：' + (err?.message || err));
      }
    }

    async function saveLessonFromForm() {
      if (!await isAdmin()) { alert('只有管理者可以操作'); return; }

      const courseId = Number(document.getElementById('ac-id').value || 0);
      if (!courseId) { alert('請先選擇或建立課程'); return; }

      const payload = {
        course_id: courseId,
        order_no:  Number(document.getElementById('al-order').value || 1),
        title:     document.getElementById('al-title').value.trim(),
        content:   document.getElementById('al-content').value.trim() || null,
      };
      const id = Number(document.getElementById('al-id').value || 0);
      if (!payload.title) { alert('請填寫單元標題'); return; }
      if (payload.order_no <= 0) { alert('順序需為正整數'); return; }

      try {
        if (id) {
          const { error } = await sb.from('lessons').update(payload).eq('id', id);
          if (error) throw error;
          alert('單元已更新');
        } else {
          const { error } = await sb.from('lessons').insert([payload]);
          if (error) throw error;
          alert('單元已新增');
        }
        document.getElementById('al-id').value = '';
        await adminLoadLessons(courseId);
      } catch (err) {
        console.error('saveLesson error:', err);
        alert('儲存單元失敗：' + (err?.message || err));
      }
    }

    // 綁定事件
    document.getElementById('admin-course-form')?.addEventListener('submit', async (e)=>{
      e.preventDefault(); e.stopPropagation(); await saveCourseFromForm();
    });
    document.getElementById('admin-lesson-form')?.addEventListener('submit', async (e)=>{
      e.preventDefault(); e.stopPropagation(); await saveLessonFromForm();
    });

    document.getElementById('admin-refresh')?.addEventListener('click', adminRefresh);
    document.getElementById('admin-new-course')?.addEventListener('click', ()=>{
      adminFillCourseForm(null);
      const ls = document.getElementById('admin-lessons');
      if (ls) ls.innerHTML = '<p class="muted">尚無單元。</p>';
    });

    document.getElementById('admin-soft-delete')?.addEventListener('click', async ()=>{
      if (!await isAdmin()) return alert('只有管理者可以操作');
      const id = Number(document.getElementById('ac-id').value || 0);
      if (!id) return;
      if (!confirm('移到回收（可復原）？')) return;
      const { error } = await sb.from('courses')
        .update({ deleted_at: new Date().toISOString(), published: false })
        .eq('id', id);
      if (error) return alert('刪除失敗：' + error.message);
      alert('已移到回收'); await adminRefresh();
    });

    document.getElementById('admin-hard-delete')?.addEventListener('click', async ()=>{
      if (!await isAdmin()) return alert('只有管理者可以操作');
      const id = Number(document.getElementById('ac-id').value || 0);
      if (!id) return;
      if (!confirm('⚠ 永久刪除課程與所有單元，確定？')) return;
      const { error } = await sb.from('courses').delete().eq('id', id);
      if (error) return alert('刪除失敗：' + error.message);
      alert('已永久刪除'); await adminRefresh();
    });

    document.getElementById('admin-lesson-delete')?.addEventListener('click', async ()=>{
      if (!await isAdmin()) return alert('只有管理者可以操作');

      const courseId = Number(document.getElementById('ac-id').value || 0);
      const lessonId = Number(document.getElementById('al-id').value || 0);
      if (!courseId) return alert('請先選擇或建立課程');
      if (!lessonId) return alert('請先在清單中點「編輯」選取要刪除的單元');

      if (!confirm('確定要刪除這個單元？此動作不可復原。')) return;

      const { error } = await sb.from('lessons').delete().eq('id', lessonId);
      if (error) return alert('刪除失敗：' + error.message);

      alert('已刪除單元');
      document.getElementById('al-id').value = '';
      await adminLoadLessons(courseId);
    });

    // 進入頁面後先刷新一次列表
    window.addEventListener('DOMContentLoaded', adminRefresh);
  </script>
</body>
</html>
