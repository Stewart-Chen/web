<!doctype html>
<html lang="zh-Hant" data-guard="checking">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>課程管理｜HeartHub Studio 心聚坊</title>

  <!-- 若 styles.css 已載入字型，可刪掉下一行 Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />

  <!-- Admin 身分檢查期間先隱藏 main，通過後再顯示 -->
  <style>
    html[data-guard="checking"] main { visibility: hidden; }
    main.page-admin { padding-top: 14px; padding-bottom: 32px; }
    .admin-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 12px;
    }
    .admin-header {
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      margin-top: 6px;
    }
    .admin-tools { display:flex; gap:8px; flex-wrap:wrap; }
    .admin-col { min-width: 0; }
    .admin-card {
      padding:16px; background:#fff; border:1px solid rgba(0,0,0,.06);
      border-radius:12px; box-shadow: var(--shadow-sm);
    }
    /* 列表 item（沿用全站風格） */
    #admin-courses .item, #admin-lessons .item{
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 10px; border:1px solid #e6e6e6; border-radius:8px; margin-bottom:8px; background:#fff;
    }
    #admin-courses, #admin-lessons { max-height: 360px; overflow: auto; }

    /* RWD：手機單欄 */
    @media (max-width: 900px){ .admin-wrap { grid-template-columns: 1fr; } }
  </style>

  <!-- Supabase SDK（本頁唯一 client：sb） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.SUPABASE_URL = "https://ilhmywiktdqilmaisbyp.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsaG15d2lrdGRxaWxtYWlzYnlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTczODcsImV4cCI6MjA3MTIzMzM4N30.qCpu7NhwaEkmyFJmg9MB6MrkcqmPiywGV2c_U3U9h4c";
    window.sb = window.sb || window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  </script>

  <!-- 守門：非登入/非管理者 → 導回首頁（不再強制切換 Header 的登入/登出） -->
  <script>
    async function guardAdminPage() {
      try {
        const { data: userData } = await sb.auth.getUser();
        const user = userData?.user;
        if (!user) { location.replace('index.html?need_login=1'); return; }

        const { data, error } = await sb
          .from('admins').select('user_id').eq('user_id', user.id).maybeSingle();

        if (error || !data) { location.replace('index.html'); return; }

        // 通過 → 顯示內容
        document.documentElement.removeAttribute('data-guard');
      } catch (err) {
        console.error('guard error:', err);
        location.replace('index.html');
      }
    }
    guardAdminPage();
  </script>
</head>
<body>
  <!-- 共用 Header / Footer（若沒有 QRCode 庫，提供 no-op 避免 shared-layout 報錯） -->
  <script>
    if (typeof window.QRCode === 'undefined') {
      window.QRCode = function(){}; window.QRCode.CorrectLevel = {L:1,M:2,Q:3,H:4};
    }
  </script>
  <script defer src="js/shared-layout.js"></script>

  <main class="container page-admin">
    <section class="admin-wrap">
      <!-- 左欄：課程清單 -->
      <div class="admin-col">
        <div class="admin-card">
          <header class="admin-header">
            <h3 style="margin:0;">課程清單</h3>
            <div class="admin-tools">
              <button type="button" class="btn" id="admin-refresh">重新整理</button>
              <button type="button" class="btn primary" id="admin-new-course">＋ 新增課程</button>
            </div>
          </header>

          <div id="admin-courses" style="margin-top:10px;">
            <!-- 由 admin.js 產生清單 -->
          </div>
        </div>
      </div>

      <!-- 右欄：課程內容 + 單元 -->
      <div class="admin-col">
        <div class="admin-card">
          <h3 style="margin:0;">課程內容</h3>
          <form id="admin-course-form" class="form-grid" style="margin-top:12px;">
            <input type="hidden" id="ac-id" />
            <label>標題 <input id="ac-title" required /></label>
            <label>摘要 <input id="ac-summary" /></label>
            <label>描述 <textarea id="ac-desc" rows="4"></textarea></label>
            <label>封面網址 <input id="ac-cover" placeholder="https://..." /></label>
            <label>授課老師
              <select id="ac-teacher" required>
                <option value="">— 選擇 —</option>
                <option value="fanfan">汎汎（園藝）</option>
                <option value="xd">小D（藝術）</option>
              </select>
            </label>
            <label><input type="checkbox" id="ac-published" /> 已發佈（公開可見）</label>

            <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;">
              <button type="submit" class="btn primary">儲存</button>
              <button type="button" id="admin-soft-delete" class="btn secondary">移到回收（軟刪除）</button>
              <button type="button" id="admin-hard-delete" class="btn danger">永久刪除</button>
            </div>
          </form>
        </div>

        <div class="admin-card" style="margin-top:16px;">
          <h3 style="margin:0;">單元（Lessons）</h3>

          <div id="admin-lessons" style="margin-top:10px;">
            <!-- 由 admin.js 產生單元清單 -->
          </div>

          <form id="admin-lesson-form" class="form-grid" style="margin-top:12px;">
            <input type="hidden" id="al-id" />
            <label>順序 <input type="number" id="al-order" min="1" value="1" required /></label>
            <label>標題 <input id="al-title" required /></label>
            <label>內容 <textarea id="al-content" rows="3"></textarea></label>
            <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;">
              <button type="submit" class="btn">新增 / 更新單元</button>
              <button type="button" id="admin-lesson-delete" class="btn danger">刪除選取單元</button>
            </div>
          </form>

          <p class="muted" style="margin-top:8px;">＊只有被加入管理者清單的帳號才能操作。</p>
        </div>
      </div>
    </section>
  </main>

  <!-- 管理頁專用邏輯（不要載入 app.js 以免混淆） -->
  <script src="js/admin.js"></script>
</body>
</html>
