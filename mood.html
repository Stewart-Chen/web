<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>å¿ƒæƒ…æº«åº¦è¨ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- æ¨£å¼èˆ‡å­—å‹ -->
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">

  <!-- JSï¼šå¤–éƒ¨/å…±ç”¨/æ‡‰ç”¨ï¼ˆèˆ‡å…¶ä»–é ä¸€è‡´ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-dialog.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/app.js"></script>
</head>
<body>
  <!-- shared-layout.js æœƒè‡ªå‹•æ’å…¥ header/footer -->
  <main class="container flow-lg">
    <section class="card">
      <header class="flow-md">
        <h2>å¿ƒæƒ…æº«åº¦è¨ˆ</h2>
        <p class="muted">è«‹ç”¨é¸æ“‡é¡Œè¨˜éŒ„ä½ ä»Šå¤©çš„ç‹€æ…‹ï¼›åªæœ‰ã€Œå‚™è¨»ã€æ˜¯é¸å¡«ã€‚</p>
      </header>

      <form id="mood-form" class="flow-md">
        <!-- 1. ä»Šæ—¥å¿ƒæƒ…ï¼ˆ1~5ï¼‰ -->
        <fieldset class="card">
          <legend><strong>1ï¼‰ä»Šå¤©çš„å¿ƒæƒ…</strong></legend>
          <div class="actions" role="radiogroup" aria-label="ä»Šå¤©çš„å¿ƒæƒ…">
            <label><input type="radio" name="mood" value="1" required> ğŸ˜ å¾ˆç³Ÿ</label>
            <label><input type="radio" name="mood" value="2"> ğŸ™ ä¸ä½³</label>
            <label><input type="radio" name="mood" value="3"> ğŸ˜ æ™®é€š</label>
            <label><input type="radio" name="mood" value="4"> ğŸ™‚ å¥½</label>
            <label><input type="radio" name="mood" value="5"> ğŸ˜„ å¾ˆæ£’</label>
          </div>
        </fieldset>

        <!-- 2. ç²¾åŠ› -->
        <fieldset class="card">
          <legend><strong>2ï¼‰ç²¾åŠ›</strong></legend>
          <div class="actions" role="radiogroup" aria-label="ç²¾åŠ›">
            <label><input type="radio" name="energy" value="low" required> ä½</label>
            <label><input type="radio" name="energy" value="mid"> ä¸­</label>
            <label><input type="radio" name="energy" value="high"> é«˜</label>
          </div>
        </fieldset>

        <!-- 3. å£“åŠ› -->
        <fieldset class="card">
          <legend><strong>3ï¼‰å£“åŠ›</strong></legend>
          <div class="actions" role="radiogroup" aria-label="å£“åŠ›">
            <label><input type="radio" name="stress" value="low" required> ä½</label>
            <label><input type="radio" name="stress" value="mid"> ä¸­</label>
            <label><input type="radio" name="stress" value="high"> é«˜</label>
          </div>
        </fieldset>

        <!-- 4. æ¨™ç±¤ï¼ˆå¯è¤‡é¸ï¼‰ -->
        <fieldset class="card">
          <legend><strong>4ï¼‰ä»Šå¤©å½±éŸ¿å¿ƒæƒ…çš„é¢å‘ï¼ˆå¯è¤‡é¸ï¼‰</strong></legend>
          <div class="actions" aria-label="å½±éŸ¿é¢å‘">
            <label><input type="checkbox" name="tags" value="work"> å·¥ä½œ</label>
            <label><input type="checkbox" name="tags" value="family"> å®¶åº­</label>
            <label><input type="checkbox" name="tags" value="study"> å­¸æ¥­</label>
            <label><input type="checkbox" name="tags" value="social"> äººéš›</label>
            <label><input type="checkbox" name="tags" value="health"> å¥åº·</label>
            <label><input type="checkbox" name="tags" value="weather"> å¤©æ°£</label>
            <label><input type="checkbox" name="tags" value="finance"> è²¡å‹™</label>
            <label><input type="checkbox" name="tags" value="other"> å…¶ä»–</label>
          </div>
        </fieldset>

        <!-- 5. æ´»å‹•ï¼ˆå¯è¤‡é¸ï¼‰ -->
        <fieldset class="card">
          <legend><strong>5ï¼‰åšäº†å“ªäº›æ´»å‹•ï¼ˆå¯è¤‡é¸ï¼‰</strong></legend>
          <div class="actions" aria-label="æ´»å‹•">
            <label><input type="checkbox" name="activities" value="exercise"> é‹å‹•/èµ°è·¯</label>
            <label><input type="checkbox" name="activities" value="art"> è—è¡“/æ‰‹ä½œ</label>
            <label><input type="checkbox" name="activities" value="plants"> ç…§é¡§æ¤ç‰©</label>
            <label><input type="checkbox" name="activities" value="meditation"> æ­£å¿µ/å†¥æƒ³</label>
            <label><input type="checkbox" name="activities" value="music"> éŸ³æ¨‚</label>
            <label><input type="checkbox" name="activities" value="rest"> ä¼‘æ¯/ç¡çœ </label>
          </div>
        </fieldset>

        <!-- å‚™è¨»ï¼ˆé¸å¡«ï¼‰ -->
        <fieldset class="card">
          <legend><strong>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</strong></legend>
          <textarea name="note" rows="3" placeholder="æƒ³è£œå……çš„å¿ƒæƒ…å°èªâ€¦ï¼ˆé¸å¡«ï¼‰"></textarea>
        </fieldset>

        <!-- æŒ‰éˆ•åˆ— -->
        <div class="actions" style="justify-content:flex-end;">
          <button type="button" class="btn" id="btn-cancel">å–æ¶ˆ</button>
          <button type="reset" class="btn secondary">é‡å¡«</button>
          <button type="submit" class="btn primary">é€å‡º</button>
        </div>
      </form>
    </section>
  </main>

  <!-- å–®é æäº¤è…³æœ¬ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('mood-form');
      const btnCancel = document.getElementById('btn-cancel');

      btnCancel?.addEventListener('click', () => {
        if (document.referrer) history.back();
        else location.href = 'index.html';
      });

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        // éœ€è¦ç™»å…¥
        if (typeof requireAuthOrOpenModal === 'function'){
          if (!requireAuthOrOpenModal(e)) return;
        }

        const fd = new FormData(form);
        // å–è¤‡é¸å€¼
        const tags = [];
        form.querySelectorAll('input[name="tags"]:checked').forEach(cb => tags.push(cb.value));
        const activities = [];
        form.querySelectorAll('input[name="activities"]:checked').forEach(cb => activities.push(cb.value));

        // URL è‹¥å¸¶æœ‰èª²ç¨‹ idï¼ˆå¯é¸ï¼‰ï¼šmood.html?id=123
        const params = new URLSearchParams(location.search);
        const courseId = params.get('id') ? Number(params.get('id')) : null;

        const user = (typeof currentUser !== 'undefined') ? currentUser : null;

        const payload = {
          user_id: user ? user.id : null,
          course_id: courseId,
          // ä»Šæ—¥æ—¥æœŸï¼ˆåªç•™æ—¥æœŸï¼Œæ–¹ä¾¿ä¹‹å¾ŒæŸ¥ã€Œä»Šå¤©ã€ï¼‰
          mood_date: new Date().toISOString().slice(0,10), // YYYY-MM-DD
          mood: Number(fd.get('mood')),
          energy: String(fd.get('energy')),
          stress: String(fd.get('stress')),
          tags,        // text[]
          activities,  // text[]
          note: String(fd.get('note') || ''),
          submitted_at: new Date().toISOString()
        };

        try {
          const { error } = await supabase.from('moods').insert(payload);
          if (error) throw error;
          alert('å·²è¨˜éŒ„ä»Šå¤©çš„å¿ƒæƒ…ï¼Œè¾›è‹¦äº† ğŸŒ¿');
          // å›åˆ°èª²ç¨‹æˆ–é¦–é 
          if (courseId) location.href = `course.html?id=${courseId}`;
          else location.href = 'index.html';
        } catch (err) {
          console.error(err);
          alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡æˆ‘å€‘ã€‚');
        }
      });
    });
  </script>
</body>
</html>
