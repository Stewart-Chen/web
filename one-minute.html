<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>心聚1分鐘｜HeartHub Studio 心聚坊</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="img/logo.png" sizes="16x16" type="image/png">
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/shared-dialog.js"></script>
  <script defer src="js/app.js"></script>
  <style>
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <main class="container flow-lg">
    <section class="card">
      <header class="flow-md">
        <h2>心聚1分鐘（<span id="tp-label">課前</span>）</h2>
        <p class="muted">只要 1 分鐘，記錄你的狀態；這些資料會轉成「心聚指標」報告。</p>
      </header>

      <!-- 控制面板：表格切換 + 手動輸入 Course / Session ID -->
      <div id="control-panel" class="card" style="margin-bottom:12px;">
        <div class="grid2" style="align-items:end; gap:12px;">
          <div>
            <label style="display:block; font-weight:600; margin-bottom:6px;">表格切換</label>
            <div class="actions" id="tp-switch" role="radiogroup" aria-label="表格切換">
              <label style="margin-right:8px;"><input type="radio" name="tp_switch" value="pre" checked>課前</label>
              <label style="margin-right:8px;"><input type="radio" name="tp_switch" value="post">課後</label>
              <label><input type="radio" name="tp_switch" value="72h">72h</label>
            </div>
          </div>
          <div>
            <label style="display:block; font-weight:600; margin-bottom:6px;">手動輸入 Course / Session ID（可留空）</label>
            <div class="grid2" style="gap:8px;">
              <input id="inp-course-id" type="number" inputmode="numeric" placeholder="course id">
              <input id="inp-session-id" type="number" inputmode="numeric" placeholder="session id">
            </div>
            <div class="actions" style="justify-content:flex-start; margin-top:8px;">
              <button type="button" class="btn" id="btn-apply-ctrls">套用</button>
              <span id="ctrls-status" class="muted" style="margin-left:8px;"></span>
            </div>
          </div>
        </div>
      </div>

      <form id="one-minute-form" class="flow-md">
        <!-- 隱藏欄位 -->
        <input type="hidden" name="timepoint" id="timepoint" value="pre">
        <input type="hidden" name="session_id" id="session_id">
        <input type="hidden" name="course_id" id="course_id">

        <!-- A. 四指標（1~5） -->
        <fieldset class="card">
          <legend><strong>1）穩定度</strong>（1 不穩 → 5 很穩）</legend>
          <div class="actions" role="radiogroup" aria-label="穩定度">
            <label><input type="radio" name="stability" value="1" required>1</label>
            <label><input type="radio" name="stability" value="2">2</label>
            <label><input type="radio" name="stability" value="3">3</label>
            <label><input type="radio" name="stability" value="4">4</label>
            <label><input type="radio" name="stability" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>2）壓力復原</strong>（1 幾乎無法復原 → 5 很快能復原）</legend>
          <div class="actions" role="radiogroup" aria-label="壓力復原">
            <label><input type="radio" name="recovery" value="1" required>1</label>
            <label><input type="radio" name="recovery" value="2">2</label>
            <label><input type="radio" name="recovery" value="3">3</label>
            <label><input type="radio" name="recovery" value="4">4</label>
            <label><input type="radio" name="recovery" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>3）社會連結</strong>（1 很疏離 → 5 很連結）</legend>
          <div class="actions" role="radiogroup" aria-label="社會連結">
            <label><input type="radio" name="connectedness" value="1" required>1</label>
            <label><input type="radio" name="connectedness" value="2">2</label>
            <label><input type="radio" name="connectedness" value="3">3</label>
            <label><input type="radio" name="connectedness" value="4">4</label>
            <label><input type="radio" name="connectedness" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>4）專注力</strong>（1 很難專心 → 5 很能專心）</legend>
          <div class="actions" role="radiogroup" aria-label="專注力">
            <label><input type="radio" name="focus" value="1" required>1</label>
            <label><input type="radio" name="focus" value="2">2</label>
            <label><input type="radio" name="focus" value="3">3</label>
            <label><input type="radio" name="focus" value="4">4</label>
            <label><input type="radio" name="focus" value="5">5</label>
          </div>
        </fieldset>

        <!-- B. NPS（所有時間點可留著；72h 可選填） -->
        <fieldset class="card">
          <legend><strong>5）你願意推薦這堂課嗎？</strong>（0–10）</legend>
          <div class="actions" role="radiogroup" aria-label="NPS">
            <label><input type="radio" name="nps" value="0" required>0</label>
            <label><input type="radio" name="nps" value="1">1</label>
            <label><input type="radio" name="nps" value="2">2</label>
            <label><input type="radio" name="nps" value="3">3</label>
            <label><input type="radio" name="nps" value="4">4</label>
            <label><input type="radio" name="nps" value="5">5</label>
            <label><input type="radio" name="nps" value="6">6</label>
            <label><input type="radio" name="nps" value="7">7</label>
            <label><input type="radio" name="nps" value="8">8</label>
            <label><input type="radio" name="nps" value="9">9</label>
            <label><input type="radio" name="nps" value="10">10</label>
          </div>
        </fieldset>

        <!-- C. 一句話收穫（選填） -->
        <fieldset class="card">
          <legend><strong>6）今天最大的收穫</strong>（60字以內）</legend>
          <textarea name="one_line" rows="2" maxlength="120" placeholder="例：我學會用3分鐘呼吸讓自己安定"></textarea>
        </fieldset>

        <!-- D. 課後限定：行動意向 + 關係圈 -->
        <fieldset id="post-only-actions" class="card">
          <legend><strong>7）接下來72小時你會做：</strong>（可複選）</legend>
          <label><input type="checkbox" name="next_actions" value="breathing_3m">3分鐘呼吸</label>
          <label><input type="checkbox" name="next_actions" value="horticulture_5m">5分鐘園藝照護</label>
          <label><input type="checkbox" name="next_actions" value="art_10m">10分鐘藝術塗鴉</label>
          <label><input type="checkbox" name="next_actions" value="gratitude_colleague">和同事/家人互相感謝</label>
          <label>其他：<input type="text" name="next_actions_other" maxlength="40"></label>
        </fieldset>

        <fieldset id="post-only-scope" class="card">
          <legend><strong>8）你會把練習帶到：</strong>（可複選）</legend>
          <label><input type="checkbox" name="adoption_scope" value="self">個人</label>
          <label><input type="checkbox" name="adoption_scope" value="family">家人</label>
          <label><input type="checkbox" name="adoption_scope" value="coworkers">同事/同學</label>
          <label><input type="checkbox" name="adoption_scope" value="community">社團/社群</label>
        </fieldset>

        <!-- 72h 限定：行動完成回報 -->
        <fieldset id="h72-only" class="card">
          <legend><strong>7）這72小時你完成了哪些行動？</strong>（可複選）</legend>
          <label><input type="checkbox" name="actions_done" value="breathing_3m">3分鐘呼吸</label>
          <label><input type="checkbox" name="actions_done" value="horticulture_5m">5分鐘園藝照護</label>
          <label><input type="checkbox" name="actions_done" value="art_10m">10分鐘藝術塗鴉</label>
          <label><input type="checkbox" name="actions_done" value="gratitude_colleague">和同事/家人互相感謝</label>
          <label>其他：<input type="text" name="actions_done_other" maxlength="40"></label>
        </fieldset>

        <!-- 按鈕列 -->
        <div class="actions" style="justify-content:flex-end;">
          <button type="button" class="btn" id="btn-cancel">取消</button>
          <button type="reset" class="btn secondary">重填</button>
          <button type="submit" class="btn primary">送出</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('one-minute-form');
      const btnCancel = document.getElementById('btn-cancel');
      const tpLabel = document.getElementById('tp-label');

      // 解析 URL 參數（若無參數，預設為課前、ID 皆空）
      const params    = new URLSearchParams(location.search);
      let tp          = (params.get('tp') || 'pre').toLowerCase(); // 'pre' | 'post' | '72h'
      let sessionId   = params.get('session') ? Number(params.get('session')) : null;
      let courseId    = params.get('course')  ? Number(params.get('course'))  : null;

      // 設定隱藏欄位（預設：tp='pre'、id 皆空；若網址有值則帶入）
      document.getElementById('timepoint').value = tp || 'pre';
      document.getElementById('session_id').value = sessionId ?? '';
      document.getElementById('course_id').value  = courseId  ?? '';

      // ---- 新增控制面板事件：tp 切換與手動輸入 id ----
      const tpSwitch       = document.getElementById('tp-switch');
      const inpCourse      = document.getElementById('inp-course-id');
      const inpSession     = document.getElementById('inp-session-id');
      const btnApplyCtrls  = document.getElementById('btn-apply-ctrls');
      const ctrlsStatus    = document.getElementById('ctrls-status');

      // 初始化控制面板（若 URL 有值就顯示，否則維持預設：課前、ID 空）
      document.querySelectorAll('#tp-switch input[name="tp_switch"]').forEach(r => {
        r.checked = (r.value === (tp || 'pre'));
      });
      inpCourse.value  = courseId ?? '';
      inpSession.value = sessionId ?? '';

      function applyTp(tpValue){
        const elPostActions = document.getElementById('post-only-actions');
        const elPostScope   = document.getElementById('post-only-scope');
        const el72h         = document.getElementById('h72-only');

        document.getElementById('timepoint').value = tpValue;

        if (tpValue === 'pre') {
          tpLabel.textContent = '課前';
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.add('hidden');
        } else if (tpValue === 'post') {
          tpLabel.textContent = '課後';
          elPostActions.classList.remove('hidden');
          elPostScope.classList.remove('hidden');
          el72h.classList.add('hidden');
        } else { // 72h
          tpLabel.textContent = '72 小時追蹤';
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.remove('hidden');
        }
      }

      // 依目前（URL 或預設）初始化一次畫面
      applyTp(tp || 'pre');

      // 切換表格（課前/課後/72h）
      tpSwitch?.addEventListener('change', () => {
        const current = document.querySelector('#tp-switch input[name="tp_switch"]:checked')?.value || 'pre';
        tp = current; // 更新目前時間點
        applyTp(current);
        ctrlsStatus.textContent = `當前：${current.toUpperCase()} 表單`;
      });

      // 套用手動輸入的 Course/Session ID（可為空）
      btnApplyCtrls?.addEventListener('click', () => {
        courseId  = inpCourse.value.trim()  ? Number(inpCourse.value.trim())  : null;
        sessionId = inpSession.value.trim() ? Number(inpSession.value.trim()) : null;

        document.getElementById('course_id').value  = courseId ?? '';
        document.getElementById('session_id').value = sessionId ?? '';

        ctrlsStatus.textContent = `已套用 Course=${(courseId ?? '∅')} / Session=${(sessionId ?? '∅')}`;
      });

      // 原本顯示/隱藏判斷（保留，確保首次載入也正確）
      const elPostActions = document.getElementById('post-only-actions');
      const elPostScope   = document.getElementById('post-only-scope');
      const el72h         = document.getElementById('h72-only');

      if (tp === 'pre') {
        tpLabel.textContent = '課前';
        elPostActions.classList.add('hidden');
        elPostScope.classList.add('hidden');
        el72h.classList.add('hidden');
      } else if (tp === 'post') {
        tpLabel.textContent = '課後';
        elPostActions.classList.remove('hidden');
        elPostScope.classList.remove('hidden');
        el72h.classList.add('hidden');
      } else { // 72h
        tpLabel.textContent = '72 小時追蹤';
        elPostActions.classList.add('hidden');
        elPostScope.classList.add('hidden');
        el72h.classList.remove('hidden');
      }

      btnCancel?.addEventListener('click', () => {
        if (document.referrer) history.back();
        else location.href = 'index.html';
      });

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (typeof requireAuthOrOpenModal === 'function'){
          if (!requireAuthOrOpenModal(e)) return;
        }

        const fd = new FormData(form);

        // 取多選值
        const getChecked = (name) => {
          return Array.from(form.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
        };

        // post 的「其他」補上
        const nextActions = getChecked('next_actions');
        const naOther = (fd.get('next_actions_other')||'').trim();
        if (naOther) nextActions.push(naOther);

        // 72h 的「其他」補上
        const doneActions = getChecked('actions_done');
        const daOther = (fd.get('actions_done_other')||'').trim();
        if (daOther) doneActions.push(daOther);

        // 送出時以「目前控制面板/隱藏欄位」為準
        const currentTp       = document.getElementById('timepoint').value || 'pre';
        const currentCourseId = document.getElementById('course_id').value ? Number(document.getElementById('course_id').value) : null;
        const currentSessionId= document.getElementById('session_id').value ? Number(document.getElementById('session_id').value) : null;

        const payload = {
          user_id: (typeof currentUser !== 'undefined' && currentUser) ? currentUser.id : null,
          course_id: currentCourseId,
          session_id: currentSessionId,
          timepoint: currentTp,
          stability: Number(fd.get('stability')),
          recovery: Number(fd.get('recovery')),
          connectedness: Number(fd.get('connectedness')),
          focus: Number(fd.get('focus')),
          nps: fd.get('nps') !== null ? Number(fd.get('nps')) : null,
          one_line: String(fd.get('one_line') || ''),
          next_actions: (currentTp === 'post') ? nextActions : [],
          actions_done: (currentTp === '72h') ? doneActions : [],
          adoption_scope: (currentTp === 'post') ? getChecked('adoption_scope') : [],
          submitted_at: new Date().toISOString()
        };

        try {
          const { error } = await sb.from('one_minute').insert(payload);
          if (error) throw error;
          alert('已送出，謝謝你的回饋 🌿');

          // 導回
          if (currentCourseId) location.href = `course.html?id=${currentCourseId}`;
          else location.href = 'index.html';
        } catch (err) {
          console.error(err);
          alert('送出失敗，請稍後再試或聯絡我們。');
        }
      });
    });
  </script>
</body>
</html>
