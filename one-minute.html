<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>å¿ƒèš 1 åˆ†é˜ï½œHeartHub Studio å¿ƒèšåŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ç«™å…§æ¨£å¼ / å­—å‹ï¼ˆç¶­æŒåŸæœ‰ä¾è³´ï¼‰ -->
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">

  <!-- SDK / å…±ç”¨è…³æœ¬ï¼šé †åºå¾ˆé‡è¦ï¼ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/shared-dialog.js"></script>
  <script defer src="js/app.js"></script>

  <!-- é€™é çš„å¼·åŒ–æ¨£å¼ï¼ˆä¸ä¾è³´å¤–éƒ¨æ¡†æ¶ï¼‰ -->
  <style>
    :root{
      --brand:#0ea5e9;           /* ä¸»è‰²ï¼šå¤©è— */
      --brand-ink:#075985;       /* æ·±è—æ–‡å­— */
      --ink:#1f2937;
      --muted:#6b7280;
      --bg:#f8fafc;              /* æ·ºç°è—èƒŒæ™¯ */
      --card:#ffffff;
      --ring:rgba(14,165,233,.35);
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --radius:14px;
      --shadow:0 6px 24px rgba(15,23,42,.08);
    }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, "Noto Serif TC", "PingFang TC", "Microsoft JhengHei", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height:1.6;
    }
    .container{
      max-width:960px; margin-inline:auto; padding:24px 16px 120px;
    }
    .page-hero{
      background:linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
      border:1px solid #e5f3ff; border-radius:18px; padding:18px 16px; margin-bottom:16px;
      display:flex; align-items:center; gap:12px;
    }
    .page-hero .emoji{ font-size:28px; }
    .page-hero h1{ font-size:20px; margin:0; letter-spacing:.5px; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px; border:1px solid #eef2f7;
    }
    .flow-sm > *+*{ margin-top:8px; }
    .flow-md > *+*{ margin-top:12px; }
    .flow-lg > *+*{ margin-top:18px; }

    /* æ™‚é–“é» segmented pills */
    .pill-group{ display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      border-radius:999px; padding:8px 14px; border:1px solid #dbe7f3; background:#fff; cursor:pointer;
      font-weight:600; letter-spacing:.5px;
      transition:.2s background, .2s color, .2s border-color, .2s transform;
      user-select:none;
    }
    .pill:hover{ transform:translateY(-1px); }
    .pill[aria-pressed="true"]{ background:var(--brand); color:#fff; border-color:var(--brand); }

    /* æ§åˆ¶å° grid */
    .ctrl-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .field label{ font-weight:600; display:block; margin-bottom:6px; color:#0f172a; }
    .input, textarea, select{
      width:100%; border:1px solid #dbe7f3; border-radius:12px; padding:12px 12px;
      outline:0; background:#fff; font-size:15px;
    }
    .input:focus, textarea:focus, select:focus{ box-shadow:0 0 0 4px var(--ring); border-color:var(--brand); }

    /* é‡è¡¨ï¼šå¤§è§¸æ§åœ“è§’æŒ‰éˆ• */
    .scale{ display:flex; gap:8px; flex-wrap:wrap; }
    .scale input{ position:absolute; opacity:0; pointer-events:none; }
    .scale .opt{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:44px; height:44px; padding:0 14px;
      border-radius:12px; border:1px solid #dbe7f3; background:#fff; cursor:pointer;
      font-weight:700; transition:.2s background,.2s border-color,.2s transform;
      user-select:none;
    }
    .scale .opt:hover{ transform:translateY(-1px); }
    .scale input:checked + .opt{
      background:#effaff; border-color:var(--brand); outline:2px solid var(--brand); outline-offset:-2px;
    }
    .legend{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .legend strong{ font-size:16px; }
    .hint{ font-size:13px; color:var(--muted); }

    /* NPS å¯è¦–åˆ†æ®µ */
    .nps-row{ display:flex; flex-wrap:wrap; gap:8px; }
    .nps-row .opt{ min-width:40px; height:40px; }

    /* å·¥å…·åˆ— / å¿«é€Ÿéµæç¤º */
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tag{ font-size:12px; padding:4px 8px; border-radius:999px; background:#eef6ff; color:var(--brand-ink); border:1px solid #dbe7f3; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius:12px; border:1px solid #dbe7f3; padding:10px 14px; background:#fff; cursor:pointer;
      font-weight:700; transition:.2s transform,.2s background,.2s color,.2s border-color;
    }
    .btn:hover{ transform:translateY(-1px); }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn.secondary{ background:#f3f7fb; }
    .btn.ghost{ background:transparent; }
    .btn.warn{ background:#fff7ed; border-color:#fde68a; }
    .btn.ok{ background:#ecfdf5; border-color:#a7f3d0; }

    /* é€²åº¦æ¢ */
    .progress{
      height:10px; background:#eef2f7; border-radius:999px; overflow:hidden;
    }
    .progress > span{
      display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand) 0%, #22d3ee 100%);
      transition: width .25s ease;
    }

    /* åº•éƒ¨æµ®å‹•é€å‡ºåˆ— */
    .dock{
      position:fixed; bottom:16px; left:0; right:0; z-index:20;
      display:flex; justify-content:center; pointer-events:none;
    }
    .dock-inner{
      pointer-events:auto;
      background:#ffffffd9; backdrop-filter: blur(8px);
      border:1px solid #e5effa; border-radius:14px; box-shadow:var(--shadow);
      padding:10px; width:min(920px, calc(100% - 24px));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .dock small{ color:var(--muted); }
    .hidden{ display:none !important; }

    /* æ”¶åˆçš„ã€Œé€²éšè¨­å®šã€ */
    details.advanced{ background:#fff; border:1px dashed #dbe7f3; border-radius:12px; padding:10px 12px; }
    details.advanced[open]{ border-style:solid; }

    /* è¡¨å–®å¡ç‰‡ç¾¤çµ„ */
    fieldset.group{ border:0; padding:0; margin:0; }
    fieldset.group + fieldset.group{ margin-top:16px; }
    fieldset.group .card{ padding:16px; }

    /* å­—æ•¸è¨ˆæ•¸å™¨ */
    .count{ font-size:12px; color:var(--muted); }

    /* æˆåŠŸ/å¤±æ•—è¨Šæ¯ */
    .alert{ border-radius:12px; padding:12px; border:1px solid transparent; }
    .alert.ok{ background:#ecfdf5; border-color:#a7f3d0; }
    .alert.danger{ background:#fef2f2; border-color:#fecaca; }

    @media (max-width:480px){
      .page-hero h1{ font-size:18px; }
      .scale .opt{ flex:1; }
      .nps-row .opt{ flex:0 0 calc(10% - 8px); }
    }
  </style>
</head>
<body>
  <main class="container flow-lg">
    <!-- é é¦– -->
    <section class="page-hero">
      <div class="emoji">ğŸŒ¿</div>
      <div>
        <h1>å¿ƒèš 1 åˆ†é˜</h1>
        <div class="muted">åªè¦ 60 ç§’ï¼Œè¨˜éŒ„ä½ çš„ç‹€æ…‹ï¼Œç´¯ç©æˆã€Œå¿ƒèšæŒ‡æ¨™ã€å ±å‘Šã€‚</div>
      </div>
    </section>

    <!-- A. æ§åˆ¶å°ï¼ˆç²¾ç°¡ + å¯æ”¶åˆé€²éšè¨­å®šï¼‰ -->
    <section class="card flow-md" aria-labelledby="ctrl-title">
      <div class="legend">
        <h2 id="ctrl-title" style="margin:0;font-size:18px;">å¿«é€Ÿåˆ‡æ›</h2>
        <div class="toolbar">
          <span class="tag">å¿«æ·éµï¼š1~5 è©•åˆ†ã€0~10 NPSã€S é€å‡ºã€R é‡å¡«ã€B è¿”å›</span>
        </div>
      </div>

      <!-- æ™‚é–“é» segmented -->
      <div class="pill-group" role="group" aria-label="æ™‚é–“é»">
        <button class="pill" data-tp="pre"  aria-pressed="true">èª²å‰</button>
        <button class="pill" data-tp="post" aria-pressed="false">èª²å¾Œ</button>
        <button class="pill" data-tp="72h"  aria-pressed="false">72 å°æ™‚è¿½è¹¤</button>
      </div>

      <!-- é€²éšè¨­å®šï¼šèª²ç¨‹/å ´æ¬¡/URL -->
      <details class="advanced">
        <summary><strong>é€²éšè¨­å®š</strong>ï¼ˆèª²ç¨‹ IDã€å ´æ¬¡ IDã€ç¶²å€ï¼‰</summary>
        <div class="ctrl-grid" style="margin-top:10px;">
          <label class="field">èª²ç¨‹ IDï¼ˆå¯ç•™ç©ºï¼‰
            <input id="ctrl-course" class="input" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ 55">
          </label>
          <label class="field">å ´æ¬¡ IDï¼ˆå¯ç•™ç©ºï¼‰
            <input id="ctrl-session" class="input" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ 101">
          </label>
          <div style="display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap;">
            <button id="ctrl-apply" class="btn">å¥—ç”¨åˆ°é é¢</button>
            <button id="ctrl-write-url" class="btn secondary">æŠŠè¨­å®šå¯«åˆ°ç¶²å€</button>
            <span id="ctrl-url" class="muted mono" style="word-break:break-all;"></span>
          </div>
        </div>
      </details>
    </section>

    <!-- é€²åº¦æ¢ -->
    <section class="card flow-sm" aria-live="polite">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div><strong>å®Œæˆåº¦</strong> <span id="progress-text" class="muted">0 / 4</span></div>
        <button id="btn-fill-3" class="btn ok" type="button" title="ä¸€éµå¡« 3 åˆ†ï¼ˆéƒ½é‚„å¥½ï¼‰">ä¸€éµå¡« 3 åˆ†</button>
      </div>
      <div class="progress"><span id="progress-bar" style="width:0%"></span></div>
    </section>

    <!-- B. è¡¨å–®æœ¬é«” -->
    <section class="card">
      <header class="flow-sm">
        <h2 style="margin:0;">å¿ƒèš 1 åˆ†é˜ï¼ˆ<span id="tp-label">èª²å‰</span>ï¼‰</h2>
        <p class="muted" style="margin:0;">åˆ†æ•¸è¶Šé«˜ä»£è¡¨ç‹€æ…‹è¶Šç†æƒ³ã€‚è«‹ç›´è¦ºé¸æ“‡ã€‚</p>
      </header>

      <form id="one-minute-form" class="flow-md">
        <!-- éš±è—æ¬„ä½ï¼ˆç”±æ§åˆ¶å°ç¶­è­·ï¼‰ -->
        <input type="hidden" name="timepoint" id="timepoint" value="pre">
        <input type="hidden" name="session_id" id="session_id">
        <input type="hidden" name="course_id"  id="course_id">

        <!-- A. å››æŒ‡æ¨™ï¼ˆ1~5ï¼‰ -->
        <fieldset class="group">
          <div class="card">
            <div class="legend">
              <strong>1ï¼‰ç©©å®šåº¦</strong>
              <span class="hint">1 ä¸ç©© â†’ 5 å¾ˆç©©</span>
            </div>
            <div class="scale" role="radiogroup" aria-label="ç©©å®šåº¦">
              <label>
                <input type="radio" name="stability" value="1" required>
                <span class="opt">1</span>
              </label>
              <label>
                <input type="radio" name="stability" value="2">
                <span class="opt">2</span>
              </label>
              <label>
                <input type="radio" name="stability" value="3">
                <span class="opt">3</span>
              </label>
              <label>
                <input type="radio" name="stability" value="4">
                <span class="opt">4</span>
              </label>
              <label>
                <input type="radio" name="stability" value="5">
                <span class="opt">5</span>
              </label>
            </div>
          </div>

          <div class="card">
            <div class="legend">
              <strong>2ï¼‰å£“åŠ›å¾©åŸ</strong>
              <span class="hint">1 å¹¾ä¹ç„¡æ³•å¾©åŸ â†’ 5 å¾ˆå¿«èƒ½å¾©åŸ</span>
            </div>
            <div class="scale" role="radiogroup" aria-label="å£“åŠ›å¾©åŸ">
              <label><input type="radio" name="recovery" value="1" required><span class="opt">1</span></label>
              <label><input type="radio" name="recovery" value="2"><span class="opt">2</span></label>
              <label><input type="radio" name="recovery" value="3"><span class="opt">3</span></label>
              <label><input type="radio" name="recovery" value="4"><span class="opt">4</span></label>
              <label><input type="radio" name="recovery" value="5"><span class="opt">5</span></label>
            </div>
          </div>

          <div class="card">
            <div class="legend">
              <strong>3ï¼‰ç¤¾æœƒé€£çµ</strong>
              <span class="hint">1 å¾ˆç–é›¢ â†’ 5 å¾ˆé€£çµ</span>
            </div>
            <div class="scale" role="radiogroup" aria-label="ç¤¾æœƒé€£çµ">
              <label><input type="radio" name="connectedness" value="1" required><span class="opt">1</span></label>
              <label><input type="radio" name="connectedness" value="2"><span class="opt">2</span></label>
              <label><input type="radio" name="connectedness" value="3"><span class="opt">3</span></label>
              <label><input type="radio" name="connectedness" value="4"><span class="opt">4</span></label>
              <label><input type="radio" name="connectedness" value="5"><span class="opt">5</span></label>
            </div>
          </div>

          <div class="card">
            <div class="legend">
              <strong>4ï¼‰å°ˆæ³¨åŠ›</strong>
              <span class="hint">1 å¾ˆé›£å°ˆå¿ƒ â†’ 5 å¾ˆèƒ½å°ˆå¿ƒ</span>
            </div>
            <div class="scale" role="radiogroup" aria-label="å°ˆæ³¨åŠ›">
              <label><input type="radio" name="focus" value="1" required><span class="opt">1</span></label>
              <label><input type="radio" name="focus" value="2"><span class="opt">2</span></label>
              <label><input type="radio" name="focus" value="3"><span class="opt">3</span></label>
              <label><input type="radio" name="focus" value="4"><span class="opt">4</span></label>
              <label><input type="radio" name="focus" value="5"><span class="opt">5</span></label>
            </div>
          </div>
        </fieldset>

        <!-- B. NPSï¼ˆ72h å¯é¸å¡«ï¼‰ -->
        <fieldset class="group">
          <div class="card">
            <div class="legend">
              <strong>5ï¼‰ä½ é¡˜æ„æ¨è–¦é€™å ‚èª²å—ï¼Ÿ</strong>
              <span id="nps-hint" class="hint">0ï¼ˆå®Œå…¨ä¸æœƒï¼‰â€“ 10ï¼ˆä¸€å®šæœƒï¼‰</span>
            </div>
            <div class="nps-row" role="radiogroup" aria-label="NPS">
              <!-- è¨­å®šç¬¬ä¸€é¡† requiredï¼ŒJS æœƒåœ¨ 72h ç§»é™¤ -->
              <label><input type="radio" name="nps" value="0" required><span class="opt">0</span></label>
              <label><input type="radio" name="nps" value="1"><span class="opt">1</span></label>
              <label><input type="radio" name="nps" value="2"><span class="opt">2</span></label>
              <label><input type="radio" name="nps" value="3"><span class="opt">3</span></label>
              <label><input type="radio" name="nps" value="4"><span class="opt">4</span></label>
              <label><input type="radio" name="nps" value="5"><span class="opt">5</span></label>
              <label><input type="radio" name="nps" value="6"><span class="opt">6</span></label>
              <label><input type="radio" name="nps" value="7"><span class="opt">7</span></label>
              <label><input type="radio" name="nps" value="8"><span class="opt">8</span></label>
              <label><input type="radio" name="nps" value="9"><span class="opt">9</span></label>
              <label><input type="radio" name="nps" value="10"><span class="opt">10</span></label>
            </div>
          </div>
        </fieldset>

        <!-- C. ä¸€å¥è©±æ”¶ç©«ï¼ˆé¸å¡«ï¼Œçµ±ä¸€ 60 å­—ï¼‰ -->
        <fieldset class="group">
          <div class="card">
            <div class="legend">
              <strong>6ï¼‰ä»Šå¤©æœ€å¤§çš„æ”¶ç©«</strong>
              <span class="hint">60 å­—ä»¥å…§</span>
            </div>
            <textarea name="one_line" rows="2" maxlength="60" class="input" placeholder="ä¾‹ï¼šæˆ‘å­¸æœƒç”¨ 3 åˆ†é˜å‘¼å¸è®“è‡ªå·±å®‰å®š"></textarea>
            <div class="count"><span id="one-line-count">0</span> / 60</div>
          </div>
        </fieldset>

        <!-- D. èª²å¾Œé™å®šï¼šè¡Œå‹•æ„å‘ + é—œä¿‚åœˆ -->
        <fieldset id="post-only-actions" class="group">
          <div class="card">
            <div class="legend">
              <strong>7ï¼‰æ¥ä¸‹ä¾† 72 å°æ™‚ä½ æœƒåšï¼š</strong>
              <span class="hint">å¯è¤‡é¸</span>
            </div>
            <div class="toolbar">
              <label><input type="checkbox" name="next_actions" value="breathing_3m"> 3 åˆ†é˜å‘¼å¸</label>
              <label><input type="checkbox" name="next_actions" value="horticulture_5m"> 5 åˆ†é˜åœ’è—ç…§è­·</label>
              <label><input type="checkbox" name="next_actions" value="art_10m"> 10 åˆ†é˜è—è¡“å¡—é´‰</label>
              <label><input type="checkbox" name="next_actions" value="gratitude_colleague"> å’ŒåŒäº‹/å®¶äººäº’ç›¸æ„Ÿè¬</label>
              <label>å…¶ä»–ï¼š<input type="text" name="next_actions_other" maxlength="40" class="input" style="width:220px;"></label>
            </div>
          </div>
        </fieldset>

        <fieldset id="post-only-scope" class="group">
          <div class="card">
            <div class="legend">
              <strong>8ï¼‰ä½ æœƒæŠŠç·´ç¿’å¸¶åˆ°ï¼š</strong>
              <span class="hint">å¯è¤‡é¸</span>
            </div>
            <div class="toolbar">
              <label><input type="checkbox" name="adoption_scope" value="self"> å€‹äºº</label>
              <label><input type="checkbox" name="adoption_scope" value="family"> å®¶äºº</label>
              <label><input type="checkbox" name="adoption_scope" value="coworkers"> åŒäº‹/åŒå­¸</label>
              <label><input type="checkbox" name="adoption_scope" value="community"> ç¤¾åœ˜/ç¤¾ç¾¤</label>
            </div>
          </div>
        </fieldset>

        <!-- 72h é™å®šï¼šè¡Œå‹•å®Œæˆå›å ± -->
        <fieldset id="h72-only" class="group">
          <div class="card">
            <div class="legend">
              <strong>7ï¼‰é€™ 72 å°æ™‚ä½ å®Œæˆäº†å“ªäº›è¡Œå‹•ï¼Ÿ</strong>
              <span class="hint">å¯è¤‡é¸</span>
            </div>
            <div class="toolbar">
              <label><input type="checkbox" name="actions_done" value="breathing_3m"> 3 åˆ†é˜å‘¼å¸</label>
              <label><input type="checkbox" name="actions_done" value="horticulture_5m"> 5 åˆ†é˜åœ’è—ç…§è­·</label>
              <label><input type="checkbox" name="actions_done" value="art_10m"> 10 åˆ†é˜è—è¡“å¡—é´‰</label>
              <label><input type="checkbox" name="actions_done" value="gratitude_colleague"> å’ŒåŒäº‹/å®¶äººäº’ç›¸æ„Ÿè¬</label>
              <label>å…¶ä»–ï¼š<input type="text" name="actions_done_other" maxlength="40" class="input" style="width:220px;"></label>
            </div>
          </div>
        </fieldset>

        <!-- è¡¨å–®è¨Šæ¯ -->
        <div id="form-msg" class="alert hidden" role="status" aria-live="polite"></div>

        <!-- æŒ‰éˆ•åˆ— -->
        <div class="toolbar" style="justify-content:flex-end;">
          <button type="button" class="btn" id="btn-cancel">è¿”å›</button>
          <button type="reset" class="btn secondary" id="btn-reset">é‡å¡«</button>
          <button type="submit" class="btn primary">é€å‡º</button>
        </div>
      </form>
    </section>
  </main>

  <!-- åº•éƒ¨æµ®å‹•é€å‡ºåˆ—ï¼ˆæ²å‹•æ™‚ç‰¹åˆ¥å¥½ç”¨ï¼‰ -->
  <div class="dock">
    <div class="dock-inner">
      <div>
        <strong>å¿ƒèš 1 åˆ†é˜ï½œ<span id="dock-tp">èª²å‰</span></strong>
        <div class="muted" id="dock-meta">èª²ç¨‹ï¼šâ€”ã€€å ´æ¬¡ï¼šâ€”</div>
      </div>
      <div class="toolbar">
        <small id="dock-status">å°šæœªå¡«å¯«</small>
        <button id="dock-submit" class="btn primary">é€å‡º</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== å¿«é€Ÿå–å¾—å…ƒç´  =====
      const $ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      // æ§åˆ¶å°
      const pills = $$('.pill[data-tp]');
      const tpLabel = $('#tp-label');
      const inputCourse  = $('#ctrl-course');
      const inputSession = $('#ctrl-session');
      const btnApply     = $('#ctrl-apply');
      const btnWriteUrl  = $('#ctrl-write-url');
      const urlBox       = $('#ctrl-url');

      // è¡¨å–®/å€å¡Š
      const form = $('#one-minute-form');
      const btnCancel = $('#btn-cancel');
      const btnReset  = $('#btn-reset');

      const hTimepoint = $('#timepoint');
      const hCourseId  = $('#course_id');
      const hSessionId = $('#session_id');

      const elPostActions = $('#post-only-actions');
      const elPostScope   = $('#post-only-scope');
      const el72h         = $('#h72-only');

      const npsInputs = $$('input[name="nps"]');
      const npsHint   = $('#nps-hint');

      const progressText = $('#progress-text');
      const progressBar  = $('#progress-bar');
      const btnFill3     = $('#btn-fill-3');

      const oneLine      = $('textarea[name="one_line"]');
      const oneLineCount = $('#one-line-count');

      const formMsg      = $('#form-msg');

      // Dock
      const dockTp       = $('#dock-tp');
      const dockMeta     = $('#dock-meta');
      const dockStatus   = $('#dock-status');
      const dockSubmit   = $('#dock-submit');

      // ===== ç‹€æ…‹ =====
      let currentTp = 'pre';
      let currentCourse = null;
      let currentSession = null;

      // å˜—è©¦å¾ç¶²å€å¸¶åˆå€¼ï¼ˆè‹¥ç„¡å°±ç”¨é è¨­ï¼‰
      const params = new URLSearchParams(location.search);
      if (['pre','post','72h'].includes((params.get('tp')||'').toLowerCase())) {
        currentTp = params.get('tp').toLowerCase();
      }
      currentCourse  = params.get('course')  ? Number(params.get('course'))  : null;
      currentSession = params.get('session') ? Number(params.get('session')) : null;

      // ===== å·¥å…·ï¼šUI åŒæ­¥ =====
      function syncPills(){
        pills.forEach(btn => btn.setAttribute('aria-pressed', String(btn.dataset.tp === currentTp)));
      }
      function setNpsRequired(required){
        // HTML è¦ç¯„ï¼šradio group åªè¦å…¶ä¸­ä¸€é¡†å« required å³ç‚ºå¿…å¡«
        npsInputs.forEach((el,i)=> {
          if (required && i===0) el.setAttribute('required','');
          else el.removeAttribute('required');
        });
        npsHint.textContent = required ? '0ï¼ˆå®Œå…¨ä¸æœƒï¼‰â€“ 10ï¼ˆä¸€å®šæœƒï¼‰' : '0â€“10ï¼ˆæœ¬æ®µåœ¨ 72 å°æ™‚è¿½è¹¤ç‚ºé¸å¡«ï¼‰';
      }
      function applyStateToForm(){
        // éš±è—æ¬„ä½
        hTimepoint.value = currentTp;
        hCourseId.value  = currentCourse  ?? '';
        hSessionId.value = currentSession ?? '';

        // æ¨™ç±¤
        const label = (currentTp === 'pre') ? 'èª²å‰' : (currentTp === 'post' ? 'èª²å¾Œ' : '72 å°æ™‚è¿½è¹¤');
        tpLabel.textContent = label;
        dockTp.textContent  = label;

        // å€å¡Šé¡¯ç¤º/éš±è—
        if (currentTp === 'pre'){
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.add('hidden');
          setNpsRequired(true);
        } else if (currentTp === 'post'){
          elPostActions.classList.remove('hidden');
          elPostScope.classList.remove('hidden');
          el72h.classList.add('hidden');
          setNpsRequired(true);
        } else { // 72h
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.remove('hidden');
          setNpsRequired(false);
        }

        // æ§åˆ¶å°è¼¸å…¥æ¡†
        inputCourse.value  = currentCourse  ?? '';
        inputSession.value = currentSession ?? '';

        // é è¦½é€£çµ
        const base = location.origin + location.pathname;
        const qs = new URLSearchParams();
        qs.set('tp', currentTp);
        if (currentCourse  != null && currentCourse  !== '') qs.set('course',  String(currentCourse));
        if (currentSession != null && currentSession !== '') qs.set('session', String(currentSession));
        const nextUrl = base + '?' + qs.toString();
        urlBox.textContent = nextUrl;

        // Dock meta
        dockMeta.textContent = `èª²ç¨‹ï¼š${currentCourse ?? 'â€”'}ã€€å ´æ¬¡ï¼š${currentSession ?? 'â€”'}`;

        // è®€å–è‰ç¨¿
        restoreDraft();
        updateProgress();
      }

      // ===== è®Šæ›´ç›£è½ =====
      pills.forEach(btn => {
        btn.addEventListener('click', () => {
          currentTp = btn.dataset.tp;
          syncPills();
          applyStateToForm();
        });
      });

      btnApply.addEventListener('click', () => {
        const c = inputCourse.value.trim();
        const s = inputSession.value.trim();
        currentCourse  = c === '' ? null : Number(c);
        currentSession = s === '' ? null : Number(s);
        syncPills();
        applyStateToForm();
      });

      btnWriteUrl.addEventListener('click', () => {
        const base = location.origin + location.pathname;
        const qs = new URLSearchParams();
        qs.set('tp', currentTp);
        if (currentCourse  != null && currentCourse  !== '') qs.set('course',  String(currentCourse));
        if (currentSession != null && currentSession !== '') qs.set('session', String(currentSession));
        const next = base + '?' + qs.toString();
        history.pushState(null, '', next);
        urlBox.textContent = next;
      });

      window.addEventListener('popstate', () => {
        const p = new URLSearchParams(location.search);
        currentTp = (p.get('tp')||'pre').toLowerCase();
        currentCourse  = p.get('course')  ? Number(p.get('course'))  : null;
        currentSession = p.get('session') ? Number(p.get('session')) : null;
        syncPills(); applyStateToForm();
      });

      // ===== ä¾¿æ·åŠŸèƒ½ =====
      function setGroupValue(name, val){
        const radios = $$(`input[name="${name}"]`);
        const target = radios.find(r => r.value === String(val));
        if (target){ target.checked = true; target.dispatchEvent(new Event('change', {bubbles:true})); }
      }
      btnFill3.addEventListener('click', () => {
        ['stability','recovery','connectedness','focus'].forEach(k => setGroupValue(k, 3));
        showToast('å·²å¥—ç”¨ã€Œ3 åˆ†ã€åˆ°å››å€‹æŒ‡æ¨™ï¼Œå¯å†å¾®èª¿ã€‚');
      });

      // éµç›¤å¿«é€Ÿéµï¼ˆè¼¸å…¥æ¡†/æ–‡å­—å€ä¸è§¸ç™¼ï¼‰
      document.addEventListener('keydown', (e) => {
        const tag = (e.target.tagName||'').toLowerCase();
        if (tag === 'input' || tag === 'textarea') return;
        if (/^[1-5]$/.test(e.key)){
          const num = Number(e.key);
          ['stability','recovery','connectedness','focus'].forEach((name, i) => {
            // ä¾åºé¸å¡«ç¬¬ä¸€å€‹æœªå¡«çš„æ¬„ä½ï¼›è‹¥éƒ½å·²å¡«ï¼Œæ”¹ç‚ºæœ€å¾Œä¸€å€‹æ¬„ä½å¯åˆ‡æ›
            const radios = $$(`input[name="${name}"]`);
            const checked = radios.some(r=>r.checked);
            if (!checked){ setGroupValue(name, num); e.preventDefault(); throw 'filled-one'; }
            if (i===3){ setGroupValue(name, num); e.preventDefault(); }
          });
        } else if (/^\d$/.test(e.key)){ // 0~9 -> NPSï¼›Shift+0 -> 10
          const val = e.key === '0' && e.shiftKey ? 10 : Number(e.key);
          const target = $$('input[name="nps"]').find(r=>Number(r.value)===val);
          if (target){ target.checked = true; target.dispatchEvent(new Event('change', {bubbles:true})); }
        } else if (e.key.toLowerCase()==='s'){ e.preventDefault(); form.requestSubmit(); }
        else if (e.key.toLowerCase()==='r'){ e.preventDefault(); form.reset(); updateProgress(); }
        else if (e.key.toLowerCase()==='b'){ e.preventDefault(); if (document.referrer) history.back(); else location.href='index.html'; }
      });

      // å­—æ•¸è¨ˆæ•¸å™¨
      oneLine.addEventListener('input', () => { oneLineCount.textContent = oneLine.value.length; saveDraftSoon(); });

      // é€²åº¦æ¢ï¼šå››é …æ ¸å¿ƒæŒ‡æ¨™
      function countCoreFilled(){
        const names = ['stability','recovery','connectedness','focus'];
        return names.reduce((acc,n)=> acc + ($$(`input[name="${n}"]`).some(r=>r.checked) ? 1 : 0), 0);
      }
      function updateProgress(){
        const filled = countCoreFilled();
        progressText.textContent = `${filled} / 4`;
        progressBar.style.width = `${(filled/4)*100}%`;
        dockStatus.textContent = filled<4 ? `å°šç¼º ${4-filled} é¡Œæ ¸å¿ƒæŒ‡æ¨™` : 'æ ¸å¿ƒæŒ‡æ¨™å·²å®Œæˆ';
      }
      form.addEventListener('change', (e) => { if (['radio','checkbox'].includes(e.target.type)) updateProgress(); saveDraftSoon(); });

      // å–æ¶ˆ/é‡ç½®
      btnCancel?.addEventListener('click', () => {
        if (document.referrer) history.back();
        else location.href = 'index.html';
      });
      btnReset?.addEventListener('click', () => { showToast('å·²é‡ç½®è¡¨å–®'); clearDraft(); updateProgress(); });

      // Dock é€å‡º
      dockSubmit.addEventListener('click', () => form.requestSubmit());

      // ===== è‰ç¨¿å„²å­˜ï¼ˆlocalStorageï¼‰ =====
      const draftKey = () => `oneMinuteDraft:${currentTp}:${currentCourse ?? ''}:${currentSession ?? ''}`;
      let draftTimer = null;
      function saveDraftSoon(){
        clearTimeout(draftTimer);
        draftTimer = setTimeout(saveDraft, 400);
      }
      function saveDraft(){
        const fd = new FormData(form);
        const obj = {};
        for (const [k,v] of fd.entries()){ obj[k] = v; }
        // radio/checkbox å¤šå€¼è™•ç†
        ['stability','recovery','connectedness','focus','nps'].forEach(k=>{
          const r = $$(`input[name="${k}"]:checked`)[0];
          if (r) obj[k] = r.value;
        });
        obj._ts = Date.now();
        localStorage.setItem(draftKey(), JSON.stringify(obj));
      }
      function restoreDraft(){
        try{
          const raw = localStorage.getItem(draftKey());
          if (!raw) return;
          const obj = JSON.parse(raw);
          Object.entries(obj).forEach(([k,v])=>{
            if (k.startsWith('_')) return;
            const el = form.elements[k];
            if (!el) return;
            if (el instanceof RadioNodeList){
              const r = $$(`input[name="${k}"]`).find(x=>x.value===String(v));
              if (r) r.checked = true;
            } else {
              el.value = v;
            }
          });
        }catch(e){ /* ignore */ }
      }
      function clearDraft(){ try{ localStorage.removeItem(draftKey()); }catch(e){} }

      // ===== Toast / è¨Šæ¯ =====
      function showToast(msg, type='ok'){
        formMsg.textContent = msg;
        formMsg.className = `alert ${type}`;
        formMsg.classList.remove('hidden');
        setTimeout(()=> formMsg.classList.add('hidden'), 2500);
      }

      // ===== åˆå§‹åŒ– =====
      syncPills();
      applyStateToForm();

      // ===== é€å‡ºï¼ˆå«ç©©å¥åŒ– + display_name å¸¶å…¥ï¼‰ =====
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // éœ€è¦ç™»å…¥ï¼ˆå…±ç”¨ï¼šè‹¥æœªç™»å…¥æœƒé–‹å•Ÿç™»å…¥/è¨»å†Š dialogï¼‰
        if (typeof requireAuthOrOpenModal === 'function'){
          if (!requireAuthOrOpenModal(e)) return;
        }

        const user = window.currentUser || null;
        if (!user) { showToast('è«‹å…ˆç™»å…¥å†é€å‡ºè¡¨å–®','danger'); return; }

        const displayName =
          user.user_metadata?.full_name ||
          user.user_metadata?.name ||
          user.user_metadata?.nickname || null;

        const fd = new FormData(form);
        const getChecked = (name) => $$(`input[name="${name}"]:checked`).map(cb => cb.value);

        // post çš„å…¶ä»–
        const nextActions = getChecked('next_actions');
        const naOther = (fd.get('next_actions_other')||'').trim();
        if (naOther) nextActions.push(naOther);

        // 72h çš„å…¶ä»–
        const doneActions = getChecked('actions_done');
        const daOther = (fd.get('actions_done_other')||'').trim();
        if (daOther) doneActions.push(daOther);

        const toNum = (v) => (v===null || v==='') ? null : Number(v);
        const stability     = toNum(fd.get('stability'));
        const recovery      = toNum(fd.get('recovery'));
        const connectedness = toNum(fd.get('connectedness'));
        const focus         = toNum(fd.get('focus'));
        const nps           = toNum(fd.get('nps')); // 72h å¯ç‚º null

        // åŸºæœ¬æª¢æ ¸
        if (![stability,recovery,connectedness,focus].every(n => typeof n === 'number' && n>=1 && n<=5)){
          showToast('å››å€‹æ ¸å¿ƒæŒ‡æ¨™éœ€è¦ 1~5 çš„åˆ†æ•¸','danger'); return;
        }
        if (!(currentTp === 'pre' || currentTp === 'post' || currentTp === '72h')) {
          showToast('timepoint éŒ¯èª¤','danger'); return;
        }
        if (!(nps === null || (nps>=0 && nps<=10))) {
          showToast('NPS éœ€ç‚º 0â€“10','danger'); return;
        }

        const supabase = window.sb;
        if (!supabase) { showToast('Supabase å°šæœªåˆå§‹åŒ–','danger'); return; }

        const payload = {
          user_id: user.id,
          course_id: currentCourse ?? null,
          session_id: currentSession ?? null,
          timepoint: currentTp,
          stability,
          recovery,
          connectedness,
          focus,
          nps,
          one_line: String(fd.get('one_line') || ''),
          next_actions: (currentTp === 'post') ? nextActions : [],
          actions_done: (currentTp === '72h') ? doneActions : [],
          adoption_scope: (currentTp === 'post') ? getChecked('adoption_scope') : [],
          display_name: displayName || null,
          submitted_at: new Date().toISOString()
        };

        try {
          const { error } = await supabase.from('one_minute').insert(payload);
          if (error) {
            console.error('[one_minute insert error]', error);
            showToast(`é€å‡ºå¤±æ•—ï¼š${error.message || 'ä¸æ˜éŒ¯èª¤'}`,'danger');
            return;
          }
          clearDraft();
          showToast('å·²é€å‡ºï¼Œè¬è¬ä½ çš„å›é¥‹ ğŸŒ¿','ok');
          setTimeout(() => {
            if (currentCourse) location.href = `course.html?id=${currentCourse}`;
            else location.href = 'index.html';
          }, 600);
        } catch (err) {
          console.error(err);
          showToast('é€å‡ºå¤±æ•—ï¼ˆä¾‹å¤–ï¼‰ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡æˆ‘å€‘ã€‚','danger');
        }
      });
    });
  </script>
</body>
</html>
