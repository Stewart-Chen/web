<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>å¿ƒèš 1 åˆ†é˜ï½œHeartHub Studio å¿ƒèšåŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- æ¨£å¼èˆ‡å­—å‹ -->
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">

  <!-- SDK / å…±ç”¨è…³æœ¬ï¼šé †åºå¾ˆé‡è¦ï¼ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/shared-dialog.js"></script>
  <script defer src="js/app.js"></script>

  <style>
    .hidden { display:none !important; }
    .pill-group{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ padding:6px 12px; border:1px solid #ddd; border-radius:999px; background:#fff; cursor:pointer; }
    .pill[aria-pressed="true"]{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .ctrl-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <main class="container flow-lg">

    <!-- A. æ§åˆ¶å°ï¼šåˆ‡æ› tp + è¼¸å…¥ course/sessionï¼ˆé è¨­ï¼šèª²å‰ã€ID çš†ç©ºï¼‰ -->
    <section class="card">
      <h3 style="margin:0;">å¿ƒèš 1 åˆ†é˜ â€” æ§åˆ¶å°</h3>
      <p class="muted" style="margin-top:6px;">é¸æ“‡æ™‚é–“é»èˆ‡ï¼ˆå¯é¸ï¼‰è¼¸å…¥èª²ç¨‹ / å ´æ¬¡ã€‚æŒ‰ã€Œå¥—ç”¨åˆ°é é¢ã€å³å¯æ›´æ–°ä¸‹æ–¹è¡¨å–®ï¼Œä¸å¿…é‡æ•´ã€‚</p>

      <div class="pill-group" role="group" aria-label="æ™‚é–“é»">
        <button class="pill" data-tp="pre"  aria-pressed="true">èª²å‰</button>
        <button class="pill" data-tp="post" aria-pressed="false">èª²å¾Œ</button>
        <button class="pill" data-tp="72h"  aria-pressed="false">72 å°æ™‚è¿½è¹¤</button>
      </div>

      <div class="ctrl-grid" style="margin-top:10px;">
        <label>èª²ç¨‹ IDï¼ˆå¯ç•™ç©ºï¼‰
          <input id="ctrl-course" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ 55">
        </label>
        <label>å ´æ¬¡ IDï¼ˆå¯ç•™ç©ºï¼‰
          <input id="ctrl-session" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ 101">
        </label>
        <div style="display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap;">
          <button id="ctrl-apply" class="btn">å¥—ç”¨åˆ°é é¢</button>
          <button id="ctrl-write-url" class="btn secondary">æŠŠè¨­å®šå¯«åˆ°ç¶²å€</button>
          <span id="ctrl-url" class="muted mono" style="word-break:break-all;"></span>
        </div>
      </div>
    </section>

    <!-- B. è¡¨å–®æœ¬é«” -->
    <section class="card">
      <header class="flow-md">
        <h2>å¿ƒèš 1 åˆ†é˜ï¼ˆ<span id="tp-label">èª²å‰</span>ï¼‰</h2>
        <p class="muted">åªè¦ 1 åˆ†é˜ï¼Œè¨˜éŒ„ä½ çš„ç‹€æ…‹ï¼›é€™äº›è³‡æ–™æœƒè½‰æˆã€Œå¿ƒèšæŒ‡æ¨™ã€å ±å‘Šã€‚</p>
      </header>

      <form id="one-minute-form" class="flow-md">
        <!-- éš±è—æ¬„ä½ï¼ˆç”±æ§åˆ¶å°ç¶­è­·ï¼‰ -->
        <input type="hidden" name="timepoint" id="timepoint" value="pre">
        <input type="hidden" name="session_id" id="session_id">
        <input type="hidden" name="course_id"  id="course_id">

        <!-- A. å››æŒ‡æ¨™ï¼ˆ1~5ï¼‰ -->
        <fieldset class="card">
          <legend><strong>1ï¼‰ç©©å®šåº¦</strong>ï¼ˆ1 ä¸ç©© â†’ 5 å¾ˆç©©ï¼‰</legend>
          <div class="actions" role="radiogroup" aria-label="ç©©å®šåº¦">
            <label><input type="radio" name="stability" value="1" required>1</label>
            <label><input type="radio" name="stability" value="2">2</label>
            <label><input type="radio" name="stability" value="3">3</label>
            <label><input type="radio" name="stability" value="4">4</label>
            <label><input type="radio" name="stability" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>2ï¼‰å£“åŠ›å¾©åŸ</strong>ï¼ˆ1 å¹¾ä¹ç„¡æ³•å¾©åŸ â†’ 5 å¾ˆå¿«èƒ½å¾©åŸï¼‰</legend>
          <div class="actions" role="radiogroup" aria-label="å£“åŠ›å¾©åŸ">
            <label><input type="radio" name="recovery" value="1" required>1</label>
            <label><input type="radio" name="recovery" value="2">2</label>
            <label><input type="radio" name="recovery" value="3">3</label>
            <label><input type="radio" name="recovery" value="4">4</label>
            <label><input type="radio" name="recovery" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>3ï¼‰ç¤¾æœƒé€£çµ</strong>ï¼ˆ1 å¾ˆç–é›¢ â†’ 5 å¾ˆé€£çµï¼‰</legend>
          <div class="actions" role="radiogroup" aria-label="ç¤¾æœƒé€£çµ">
            <label><input type="radio" name="connectedness" value="1" required>1</label>
            <label><input type="radio" name="connectedness" value="2">2</label>
            <label><input type="radio" name="connectedness" value="3">3</label>
            <label><input type="radio" name="connectedness" value="4">4</label>
            <label><input type="radio" name="connectedness" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>4ï¼‰å°ˆæ³¨åŠ›</strong>ï¼ˆ1 å¾ˆé›£å°ˆå¿ƒ â†’ 5 å¾ˆèƒ½å°ˆå¿ƒï¼‰</legend>
          <div class="actions" role="radiogroup" aria-label="å°ˆæ³¨åŠ›">
            <label><input type="radio" name="focus" value="1" required>1</label>
            <label><input type="radio" name="focus" value="2">2</label>
            <label><input type="radio" name="focus" value="3">3</label>
            <label><input type="radio" name="focus" value="4">4</label>
            <label><input type="radio" name="focus" value="5">5</label>
          </div>
        </fieldset>

        <!-- B. NPSï¼ˆ72h å¯é¸å¡«ï¼‰ -->
        <fieldset class="card">
          <legend><strong>5ï¼‰ä½ é¡˜æ„æ¨è–¦é€™å ‚èª²å—ï¼Ÿ</strong>ï¼ˆ0â€“10ï¼‰</legend>
          <div class="actions" role="radiogroup" aria-label="NPS">
            <label><input type="radio" name="nps" value="0" required>0</label>
            <label><input type="radio" name="nps" value="1">1</label>
            <label><input type="radio" name="nps" value="2">2</label>
            <label><input type="radio" name="nps" value="3">3</label>
            <label><input type="radio" name="nps" value="4">4</label>
            <label><input type="radio" name="nps" value="5">5</label>
            <label><input type="radio" name="nps" value="6">6</label>
            <label><input type="radio" name="nps" value="7">7</label>
            <label><input type="radio" name="nps" value="8">8</label>
            <label><input type="radio" name="nps" value="9">9</label>
            <label><input type="radio" name="nps" value="10">10</label>
          </div>
        </fieldset>

        <!-- C. ä¸€å¥è©±æ”¶ç©«ï¼ˆé¸å¡«ï¼‰ -->
        <fieldset class="card">
          <legend><strong>6ï¼‰ä»Šå¤©æœ€å¤§çš„æ”¶ç©«</strong>ï¼ˆ60å­—ä»¥å…§ï¼‰</legend>
          <textarea name="one_line" rows="2" maxlength="120" placeholder="ä¾‹ï¼šæˆ‘å­¸æœƒç”¨3åˆ†é˜å‘¼å¸è®“è‡ªå·±å®‰å®š"></textarea>
        </fieldset>

        <!-- D. èª²å¾Œé™å®šï¼šè¡Œå‹•æ„å‘ + é—œä¿‚åœˆ -->
        <fieldset id="post-only-actions" class="card">
          <legend><strong>7ï¼‰æ¥ä¸‹ä¾†72å°æ™‚ä½ æœƒåšï¼š</strong>ï¼ˆå¯è¤‡é¸ï¼‰</legend>
          <label><input type="checkbox" name="next_actions" value="breathing_3m">3åˆ†é˜å‘¼å¸</label>
          <label><input type="checkbox" name="next_actions" value="horticulture_5m">5åˆ†é˜åœ’è—ç…§è­·</label>
          <label><input type="checkbox" name="next_actions" value="art_10m">10åˆ†é˜è—è¡“å¡—é´‰</label>
          <label><input type="checkbox" name="next_actions" value="gratitude_colleague">å’ŒåŒäº‹/å®¶äººäº’ç›¸æ„Ÿè¬</label>
          <label>å…¶ä»–ï¼š<input type="text" name="next_actions_other" maxlength="40"></label>
        </fieldset>

        <fieldset id="post-only-scope" class="card">
          <legend><strong>8ï¼‰ä½ æœƒæŠŠç·´ç¿’å¸¶åˆ°ï¼š</strong>ï¼ˆå¯è¤‡é¸ï¼‰</legend>
          <label><input type="checkbox" name="adoption_scope" value="self">å€‹äºº</label>
          <label><input type="checkbox" name="adoption_scope" value="family">å®¶äºº</label>
          <label><input type="checkbox" name="adoption_scope" value="coworkers">åŒäº‹/åŒå­¸</label>
          <label><input type="checkbox" name="adoption_scope" value="community">ç¤¾åœ˜/ç¤¾ç¾¤</label>
        </fieldset>

        <!-- 72h é™å®šï¼šè¡Œå‹•å®Œæˆå›å ± -->
        <fieldset id="h72-only" class="card">
          <legend><strong>7ï¼‰é€™72å°æ™‚ä½ å®Œæˆäº†å“ªäº›è¡Œå‹•ï¼Ÿ</strong>ï¼ˆå¯è¤‡é¸ï¼‰</legend>
          <label><input type="checkbox" name="actions_done" value="breathing_3m">3åˆ†é˜å‘¼å¸</label>
          <label><input type="checkbox" name="actions_done" value="horticulture_5m">5åˆ†é˜åœ’è—ç…§è­·</label>
          <label><input type="checkbox" name="actions_done" value="art_10m">10åˆ†é˜è—è¡“å¡—é´‰</label>
          <label><input type="checkbox" name="actions_done" value="gratitude_colleague">å’ŒåŒäº‹/å®¶äººäº’ç›¸æ„Ÿè¬</label>
          <label>å…¶ä»–ï¼š<input type="text" name="actions_done_other" maxlength="40"></label>
        </fieldset>

        <!-- æŒ‰éˆ•åˆ— -->
        <div class="actions" style="justify-content:flex-end;">
          <button type="button" class="btn" id="btn-cancel">å–æ¶ˆ</button>
          <button type="reset" class="btn secondary">é‡å¡«</button>
          <button type="submit" class="btn primary">é€å‡º</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== ç‹€æ…‹ =====
      const pills = Array.from(document.querySelectorAll('.pill[data-tp]'));
      const tpLabel = document.getElementById('tp-label');
      const inputCourse  = document.getElementById('ctrl-course');
      const inputSession = document.getElementById('ctrl-session');
      const btnApply     = document.getElementById('ctrl-apply');
      const btnWriteUrl  = document.getElementById('ctrl-write-url');
      const urlBox       = document.getElementById('ctrl-url');

      const form = document.getElementById('one-minute-form');
      const btnCancel = document.getElementById('btn-cancel');

      const hTimepoint = document.getElementById('timepoint');
      const hCourseId  = document.getElementById('course_id');
      const hSessionId = document.getElementById('session_id');

      const elPostActions = document.getElementById('post-only-actions');
      const elPostScope   = document.getElementById('post-only-scope');
      const el72h         = document.getElementById('h72-only');

      // é è¨­ï¼šèª²å‰ / ids çš†ç©º
      let currentTp = 'pre';
      let currentCourse = null;
      let currentSession = null;

      // å˜—è©¦å¾ç¶²å€å¸¶åˆå€¼ï¼ˆè‹¥ç„¡å°±ç”¨é è¨­ï¼‰
      const params = new URLSearchParams(location.search);
      if (['pre','post','72h'].includes((params.get('tp')||'').toLowerCase())) {
        currentTp = params.get('tp').toLowerCase();
      }
      currentCourse  = params.get('course')  ? Number(params.get('course'))  : null;
      currentSession = params.get('session') ? Number(params.get('session')) : null;

      // åˆå§‹åŒ–æ§åˆ¶å° UI
      function syncPills(){
        pills.forEach(btn => btn.setAttribute('aria-pressed', String(btn.dataset.tp === currentTp)));
      }
      function applyStateToForm(){
        // éš±è—æ¬„ä½
        hTimepoint.value = currentTp;
        hCourseId.value  = currentCourse  ?? '';
        hSessionId.value = currentSession ?? '';

        // é¡¯ç¤ºæ¨™ç±¤
        tpLabel.textContent = (currentTp === 'pre') ? 'èª²å‰' : (currentTp === 'post' ? 'èª²å¾Œ' : '72 å°æ™‚è¿½è¹¤');

        // å€å¡Šé¡¯ç¤º/éš±è—
        if (currentTp === 'pre'){
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.add('hidden');
        } else if (currentTp === 'post'){
          elPostActions.classList.remove('hidden');
          elPostScope.classList.remove('hidden');
          el72h.classList.add('hidden');
        } else { // 72h
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.remove('hidden');
        }

        // æ§åˆ¶å°è¼¸å…¥æ¡†
        inputCourse.value  = currentCourse  ?? '';
        inputSession.value = currentSession ?? '';

        // é è¦½é€£çµ
        const base = location.origin + location.pathname;
        const qs = new URLSearchParams();
        qs.set('tp', currentTp);
        if (currentCourse  != null && currentCourse  !== '') qs.set('course',  String(currentCourse));
        if (currentSession != null && currentSession !== '') qs.set('session', String(currentSession));
        urlBox.textContent = base + '?' + qs.toString();
      }

      // ç¶å®š pill é»æ“Š
      pills.forEach(btn => {
        btn.addEventListener('click', () => {
          currentTp = btn.dataset.tp;
          syncPills();
          applyStateToForm();
        });
      });

      // å¥—ç”¨åˆ°é é¢ï¼ˆä¸æ”¹ç¶²å€ï¼‰
      btnApply.addEventListener('click', () => {
        const c = inputCourse.value.trim();
        const s = inputSession.value.trim();
        currentCourse  = c === '' ? null : Number(c);
        currentSession = s === '' ? null : Number(s);
        syncPills();
        applyStateToForm();
      });

      // æŠŠç‹€æ…‹å¯«åˆ°ç¶²å€ï¼ˆpushStateï¼Œä¸åˆ·æ–°é é¢ï¼‰
      btnWriteUrl.addEventListener('click', () => {
        const base = location.origin + location.pathname;
        const qs = new URLSearchParams();
        qs.set('tp', currentTp);
        if (currentCourse  != null && currentCourse  !== '') qs.set('course',  String(currentCourse));
        if (currentSession != null && currentSession !== '') qs.set('session', String(currentSession));
        const next = base + '?' + qs.toString();
        history.pushState(null, '', next);
        urlBox.textContent = next;
      });

      // åˆå§‹åŒ–ä¸€æ¬¡
      syncPills();
      applyStateToForm();

      // å–æ¶ˆè¿”å›
      btnCancel?.addEventListener('click', () => {
        if (document.referrer) history.back();
        else location.href = 'index.html';
      });

      // ===== é€å‡ºï¼ˆå«ç©©å¥åŒ– + display_name å¸¶å…¥ï¼‰ =====
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // éœ€è¦ç™»å…¥ï¼ˆæœƒè‡ªå‹•é–‹ç™»å…¥/è¨»å†Š dialogï¼‰
        if (typeof requireAuthOrOpenModal === 'function'){
          if (!requireAuthOrOpenModal(e)) return;
        }

        const user = window.currentUser || null;
        if (!user) { alert('è«‹å…ˆç™»å…¥å†é€å‡ºè¡¨å–®'); return; }

        const displayName =
          user.user_metadata?.full_name ||
          user.user_metadata?.name ||
          user.user_metadata?.nickname || null;

        const fd = new FormData(form);
        const getChecked = (name) => Array.from(form.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        // post çš„å…¶ä»–
        const nextActions = getChecked('next_actions');
        const naOther = (fd.get('next_actions_other')||'').trim();
        if (naOther) nextActions.push(naOther);

        // 72h çš„å…¶ä»–
        const doneActions = getChecked('actions_done');
        const daOther = (fd.get('actions_done_other')||'').trim();
        if (daOther) doneActions.push(daOther);

        const toNum = (v) => (v===null || v==='') ? null : Number(v);
        const stability     = toNum(fd.get('stability'));
        const recovery      = toNum(fd.get('recovery'));
        const connectedness = toNum(fd.get('connectedness'));
        const focus         = toNum(fd.get('focus'));
        const nps           = toNum(fd.get('nps'));

        if (![stability,recovery,connectedness,focus].every(n => typeof n === 'number' && n>=1 && n<=5)){
          alert('å››å€‹æ ¸å¿ƒæŒ‡æ¨™éœ€è¦ 1~5 çš„åˆ†æ•¸'); return;
        }
        if (!(currentTp === 'pre' || currentTp === 'post' || currentTp === '72h')) {
          alert('timepoint éŒ¯èª¤'); return;
        }
        if (!(nps === null || (nps>=0 && nps<=10))) {
          alert('NPS éœ€ç‚º 0â€“10'); return;
        }

        const supabase = window.sb;
        if (!supabase) { alert('Supabase å°šæœªåˆå§‹åŒ–'); return; }

        const payload = {
          user_id: user.id,
          course_id: currentCourse ?? null,
          session_id: currentSession ?? null,
          timepoint: currentTp,
          stability,
          recovery,
          connectedness,
          focus,
          nps,
          one_line: String(fd.get('one_line') || ''),
          next_actions: (currentTp === 'post') ? nextActions : [],
          actions_done: (currentTp === '72h') ? doneActions : [],
          adoption_scope: (currentTp === 'post') ? getChecked('adoption_scope') : [],
          display_name: displayName || null,
          submitted_at: new Date().toISOString()
        };

        try {
          const { error } = await supabase.from('one_minute').insert(payload);
          if (error) {
            console.error('[one_minute insert error]', error);
            alert(`é€å‡ºå¤±æ•—ï¼š
- code: ${error.code || 'n/a'}
- message: ${error.message || 'n/a'}
- details: ${error.details || 'n/a'}`);
            return;
          }
          alert('å·²é€å‡ºï¼Œè¬è¬ä½ çš„å›é¥‹ ğŸŒ¿');
          if (currentCourse) location.href = `course.html?id=${currentCourse}`;
          else location.href = 'index.html';
        } catch (err) {
          console.error(err);
          alert('é€å‡ºå¤±æ•—ï¼ˆä¾‹å¤–ï¼‰ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡æˆ‘å€‘ã€‚');
        }
      });

      // è¿”å›æ™‚ç¶­æŒ UI
      window.addEventListener('popstate', () => {
        const p = new URLSearchParams(location.search);
        currentTp = (p.get('tp')||'pre').toLowerCase();
        currentCourse  = p.get('course')  ? Number(p.get('course'))  : null;
        currentSession = p.get('session') ? Number(p.get('session')) : null;
        syncPills(); applyStateToForm();
      });
    });
  </script>
</body>
</html>
