<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>心聚1分鐘｜HeartHub Studio 心聚坊</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/shared-dialog.js"></script>
  <script defer src="js/app.js"></script>
  <style>
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header id="site-header"></header>

  <main class="container narrow">
    <section class="flow-lg">
      <header class="flow-md">
        <h2>心聚1分鐘（<span id="tp-label">課前</span>）</h2>
      </header>

      <!-- 控制面板：表格切換 + 手動輸入 Course/Session ID -->
      <div id="control-panel" class="card" style="margin:10px 0; padding:12px;">
        <div class="grid2" style="align-items:end; gap:12px;">
          <div>
            <label style="display:block; font-weight:600; margin-bottom:6px;">表格切換</label>
            <div class="actions" id="tp-switch" role="radiogroup" aria-label="表格切換">
              <label style="margin-right:8px;"><input type="radio" name="tp_switch" value="pre" checked>課前</label>
              <label style="margin-right:8px;"><input type="radio" name="tp_switch" value="post">課後</label>
              <label><input type="radio" name="tp_switch" value="72h">72h</label>
            </div>
          </div>
          <div>
            <label style="display:block; font-weight:600; margin-bottom:6px;">手動輸入 Course / Session ID</label>
            <div class="grid2" style="gap:8px;">
              <input id="inp-course-id" type="number" inputmode="numeric" placeholder="course id（可留空）" />
              <input id="inp-session-id" type="number" inputmode="numeric" placeholder="session id（可留空）" />
            </div>
            <div class="actions" style="justify-content:flex-start; margin-top:8px;">
              <button type="button" class="btn" id="btn-apply-ctrls">套用</button>
              <span id="ctrls-status" class="muted" style="margin-left:8px;"></span>
            </div>
          </div>
        </div>
      </div>

      <p class="muted">
        本表單用於課前/課後/72h 的一分鐘快速回饋。請依照當下時間點選擇上方切換。<br>
        （若以網址帶入 <code>?tp=pre|post|72h&course=123&session=456</code>，會自動帶入。）
      </p>

      <form id="one-minute-form" class="flow-md">
        <!-- 隱藏欄位（若原始沒有則自動補齊） -->
        <input type="hidden" id="timepoint" name="timepoint">
        <input type="hidden" id="course_id" name="course_id">
        <input type="hidden" id="session_id" name="session_id">

        <fieldset class="card">
          <legend><strong>基本資訊</strong></legend>
          <div class="grid2">
            <label>姓名
              <input type="text" name="name" placeholder="可留空" autocomplete="name">
            </label>
            <label>Email
              <input type="email" name="email" placeholder="可留空" autocomplete="email">
            </label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>1）情緒狀態</strong>（1 很難受 → 5 很舒服）</legend>
          <div class="actions" role="radiogroup" aria-label="情緒狀態">
            <label><input type="radio" name="mood" value="1" required>1</label>
            <label><input type="radio" name="mood" value="2">2</label>
            <label><input type="radio" name="mood" value="3">3</label>
            <label><input type="radio" name="mood" value="4">4</label>
            <label><input type="radio" name="mood" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>2）身體復原力</strong>（1 很弱 → 5 很好）</legend>
          <div class="actions" role="radiogroup" aria-label="身體復原力">
            <label><input type="radio" name="recovery" value="1" required>1</label>
            <label><input type="radio" name="recovery" value="2">2</label>
            <label><input type="radio" name="recovery" value="3">3</label>
            <label><input type="radio" name="recovery" value="4">4</label>
            <label><input type="radio" name="recovery" value="5">5</label>
          </div>
        </fieldset>

        <fieldset class="card">
          <legend><strong>3）社會連結</strong>（1 很疏離 → 5 很連結）</legend>
          <div class="actions" role="radiogroup" aria-label="社會連結">
            <label><input type="radio" name="connectedness" value="1" required>1</label>
            <label><input type="radio" name="connectedness" value="2">2</label>
            <label><input type="radio" name="connectedness" value="3">3</label>
            <label><input type="radio" name="connectedness" value="4">4</label>
            <label><input type="radio" name="connectedness" value="5">5</label>
          </div>
        </fieldset>

        <!-- 課後專屬區塊 -->
        <section id="post-only-actions" class="card hidden">
          <h3 style="margin-top:0;">課後：課程體驗</h3>
          <label>今天課程讓我感到
            <select name="post_feel">
              <option value="">（請選擇）</option>
              <option value="relaxed">放鬆</option>
              <option value="energized">有能量</option>
              <option value="neutral">普通</option>
              <option value="tired">有些疲倦</option>
            </select>
          </label>
          <label>今天最有感的一件事（可留空）
            <textarea name="post_note" rows="3" placeholder="自由填寫"></textarea>
          </label>
        </section>

        <!-- 課後專屬：資料範圍 -->
        <section id="post-only-scope" class="card hidden">
          <h3 style="margin-top:0;">課後：資料範圍</h3>
          <label class="checkbox"><input type="checkbox" name="share_to_course"> 同步至課程層級（匿名彙整）</label>
          <label class="checkbox"><input type="checkbox" name="share_to_session"> 同步至單堂層級（匿名彙整）</label>
        </section>

        <!-- 72h 專屬區塊 -->
        <section id="h72-only" class="card hidden">
          <h3 style="margin-top:0;">72h 回饋</h3>
          <label>過去兩天的整體狀態
            <select name="h72_state">
              <option value="">（請選擇）</option>
              <option value="better">更好</option>
              <option value="same">差不多</option>
              <option value="worse">較差</option>
            </select>
          </label>
          <label>想補充的話（可留空）
            <textarea name="h72_note" rows="3" placeholder="自由填寫"></textarea>
          </label>
        </section>

        <div class="actions" style="justify-content:flex-end;">
          <button type="button" class="btn" id="btn-cancel">取消</button>
          <button type="reset" class="btn secondary">重填</button>
          <button type="submit" class="btn primary">送出</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('one-minute-form');
      const btnCancel = document.getElementById('btn-cancel');
      const tpLabel = document.getElementById('tp-label');

      // 解析 URL 參數
      const params   = new URLSearchParams(location.search);
      const tp       = (params.get('tp') || 'pre').toLowerCase(); // 'pre' | 'post' | '72h'
      const sessionId= params.get('session') ? Number(params.get('session')) : null;
      const courseId = params.get('course')  ? Number(params.get('course'))  : null;

      // 設定隱藏欄位
      document.getElementById('timepoint').value = tp;
      document.getElementById('session_id').value = sessionId || '';
      document.getElementById('course_id').value  = courseId  || '';

      // ==== UI controls for tp/course/session ====
      const tpSwitch = document.getElementById('tp-switch');
      const inpCourse = document.getElementById('inp-course-id');
      const inpSession = document.getElementById('inp-session-id');
      const btnApplyCtrls = document.getElementById('btn-apply-ctrls');
      const ctrlsStatus = document.getElementById('ctrls-status');

      // Initialize controls based on URL (if provided) otherwise defaults (pre, empty IDs)
      const uiInitTp = (params.get('tp') || 'pre').toLowerCase();
      const uiInitCourse = params.get('course') ? Number(params.get('course')) : null;
      const uiInitSession = params.get('session') ? Number(params.get('session')) : null;

      // 如果網址有帶值就呈現，否則保持預設（課前、空白）
      document.querySelectorAll('#tp-switch input[name="tp_switch"]').forEach(r => {
        r.checked = (r.value === uiInitTp);
      });

      inpCourse.value = uiInitCourse ?? '';
      inpSession.value = uiInitSession ?? '';

      // helper: 套用 tp 到頁面（更新隱藏欄位與顯示區塊）
      function applyTp(tpValue){
        document.getElementById('timepoint').value = tpValue;
        // 重用原本顯示/隱藏邏輯
        const elPostActions = document.getElementById('post-only-actions');
        const elPostScope   = document.getElementById('post-only-scope');
        const el72h         = document.getElementById('h72-only');

        if (tpValue === 'pre'){
          tpLabel.textContent = '課前';
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.add('hidden');
        } else if (tpValue === 'post'){
          tpLabel.textContent = '課後';
          elPostActions.classList.remove('hidden');
          elPostScope.classList.remove('hidden');
          el72h.classList.add('hidden');
        } else {
          tpLabel.textContent = '72h';
          elPostActions.classList.add('hidden');
          elPostScope.classList.add('hidden');
          el72h.classList.remove('hidden');
        }
      }

      // 初始化一次（依 URL 或預設）
      applyTp(uiInitTp);

      // 切換事件：即時改變畫面
      tpSwitch?.addEventListener('change', () => {
        const val = document.querySelector('#tp-switch input[name="tp_switch"]:checked')?.value || 'pre';
        applyTp(val);
        ctrlsStatus.textContent = `當前：${val.toUpperCase()} 表單`;
      });

      // 套用 Course/Session ID（可為空）
      btnApplyCtrls?.addEventListener('click', () => {
        const c = inpCourse.value.trim();
        const s = inpSession.value.trim();
        document.getElementById('course_id').value = c;
        document.getElementById('session_id').value = s;
        ctrlsStatus.textContent = `已套用 Course=${c||'∅'} / Session=${s||'∅'}`;
      });
      // ==== end UI controls ====

      // 顯示/隱藏區塊
      const elPostActions = document.getElementById('post-only-actions');
      const elPostScope   = document.getElementById('post-only-scope');
      const el72h         = document.getElementById('h72-only');

      if (tp === 'pre') {
        tpLabel.textContent = '課前';
        elPostActions.classList.add('hidden');
        elPostScope.classList.add('hidden');
        el72h.classList.add('hidden');
      } else if (tp === 'post') {
        tpLabel.textContent = '課後';
        elPostActions.classList.remove('hidden');
        elPostScope.classList.remove('hidden');
        el72h.classList.add('hidden');
      } else { // 72h
        tpLabel.textContent = '72h';
        elPostActions.classList.add('hidden');
        elPostScope.classList.add('hidden');
        el72h.classList.remove('hidden');
      }

      btnCancel?.addEventListener('click', () => {
        if (document.referrer) history.back();
        else location.href = 'index.html';
      });

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (typeof requireAuthOrOpenModal === 'function'){
          if (!requireAuthOrOpenModal(e)) return;
        }

        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());

        try {
          if (!window.supabaseClient) {
            alert('尚未初始化資料庫連線。');
            return;
          }
          const { data, error } = await window.supabaseClient
            .from('one_minute')
            .insert([{
              timepoint: payload.timepoint || 'pre',
              course_id: payload.course_id ? Number(payload.course_id) : null,
              session_id: payload.session_id ? Number(payload.session_id) : null,
              name: payload.name || null,
              email: payload.email || null,
              mood: payload.mood ? Number(payload.mood) : null,
              recovery: payload.recovery ? Number(payload.recovery) : null,
              connectedness: payload.connectedness ? Number(payload.connectedness) : null,
              post_feel: payload.post_feel || null,
              post_note: payload.post_note || null,
              share_to_course: !!payload.share_to_course,
              share_to_session: !!payload.share_to_session,
              h72_state: payload.h72_state || null,
              h72_note: payload.h72_note || null,
            }]).select();

          if (error) throw error;
          alert('已送出，感謝你的回饋！');
          form.reset();
          // 維持控制面板的 tp/ID 狀態
          const currentTp = document.querySelector('#tp-switch input[name="tp_switch"]:checked')?.value || 'pre';
          applyTp(currentTp);
        } catch (err) {
          console.error(err);
          alert('送出時發生錯誤，請稍後再試。');
        }
      });
    });
  </script>
</body>
</html>
