<!doctype html>
<html lang="zh-Hant" data-guard="checking">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>量表編輯｜HeartHub Studio 心聚坊</title>

  <!-- 樣式與字型（比照 admin.html） -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    html[data-guard="checking"] main { visibility: hidden; }
    main.page-admin { padding-top: 14px; padding-bottom: 32px; }
    .admin-wrap { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:12px; }
    .admin-card { padding:16px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; box-shadow:var(--shadow-sm); }
    .grid2 { display:grid; grid-template-columns:repeat(2,minmax(220px,1fr)); gap:12px; }
    .grid3 { display:grid; grid-template-columns:repeat(3,minmax(180px,1fr)); gap:16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .wrap { word-break: break-all; }
    .btn.copy { padding:6px 10px; font-size:12px; }
    @media (max-width: 900px){ .admin-wrap { grid-template-columns:1fr; } }
  </style>

  <!-- SDK / 共用腳本（比照 admin.html） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/admin.js"></script>
  <script defer src="js/app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- 守門：使用 sb（和 admin.html 一致） -->
  <script defer>
    function waitForSB(cb, tries=60){
      if (window.sb) return cb();
      if (tries <= 0) return console.error('guard: sb not ready');
      setTimeout(()=>waitForSB(cb, tries-1), 100);
    }
    async function guardAdminPage() {
      try {
        const { data: userData } = await sb.auth.getUser();
        const user = userData?.user;
        if (!user) { location.replace('index.html?need_login=1'); return; }
        const { data, error } = await sb.from('admins').select('user_id').eq('user_id', user.id).maybeSingle();
        if (error || !data) { location.replace('index.html'); return; }
        document.documentElement.removeAttribute('data-guard');
      } catch (err) {
        console.error('guard error:', err);
        location.replace('index.html');
      }
    }
    waitForSB(guardAdminPage);
  </script>
</head>
<body>
  <!-- 若缺 QRCode，提供 no-op（比照 admin.html 的容錯） -->
  <script>
    if (typeof window.QRCode === 'undefined') {
      window.QRCode = function(){}; window.QRCode.CorrectLevel = {L:1,M:2,Q:3,H:4};
    }
  </script>

  <main class="container page-admin">
    <section class="admin-wrap">
      <!-- 左欄：產生表單連結與 QR -->
      <div class="admin-card">
        <h3 style="margin:0;">A. 心聚 1 分鐘表單連結 / QR</h3>
        <p class="muted" style="margin-top:6px;">
          同一支 <code class="mono">one-minute.html</code>，以 <code class="mono">tp=pre|post|72h</code> 切換課前/課後/72h。
          先選擇「現有課程」或手動輸入 id，再按「重新整理」。
        </p>

        <div class="grid2" style="margin-top:10px;">
          <label>選擇課程（最近 50 筆）
            <select id="course-select">
              <option value="">— 請選擇課程 —</option>
            </select>
          </label>

          <label>或手動輸入課程 ID
            <input id="course-input" type="number" placeholder="例如 55" />
          </label>

          <label>場次編號（session，可空）
            <input id="session-input" type="number" placeholder="例如 101" />
          </label>

          <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
            <button id="btn-refresh" class="btn">重新整理連結與 QR</button>
          </div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <a id="btn-pre"  class="btn">課前表單</a>
          <a id="btn-post" class="btn secondary">課後表單</a>
          <a id="btn-72h"  class="btn outline">72 小時追蹤</a>
        </div>

        <div class="grid3" style="margin-top:12px;">
          <div>
            <div id="qr-pre"></div>
            <p id="url-pre"  class="muted wrap mono">—</p>
            <button class="btn copy" data-copy="#url-pre">複製連結</button>
          </div>
          <div>
            <div id="qr-post"></div>
            <p id="url-post" class="muted wrap mono">—</p>
            <button class="btn copy" data-copy="#url-post">複製連結</button>
          </div>
          <div>
            <div id="qr-72h"></div>
            <p id="url-72h" class="muted wrap mono">—</p>
            <button class="btn copy" data-copy="#url-72h">複製連結</button>
          </div>
        </div>

        <p class="muted" style="margin-top:8px;">
          <small>提示：若 <code class="mono">course</code> 留空，連結仍可開啟頁面，但若 <code class="mono">one_minute.course_id</code> 設有外鍵，寫入會失敗。建議總是帶入存在的課程 id。</small>
        </p>
      </div>

      <!-- 右欄：測試課程工具 -->
      <div class="admin-card">
        <h3 style="margin:0;">B. 測試課程工具（僅管理員）</h3>
        <p class="muted" style="margin-top:6px;">
          快速建立一筆【測試】課程（category：<span class="mono">horti</span>），或查詢／清除。
          需要 RLS 允許目前登入者可對 <code class="mono">public.courses</code> 進行 <em>insert/delete/select</em>。
        </p>

        <div class="actions" style="margin-top:8px;">
          <button id="btn-create-course" class="btn">建立測試課程</button>
          <button id="btn-list-course" class="btn secondary">查詢測試課程</button>
          <button id="btn-clear-course" class="btn danger">清除測試課程</button>
        </div>

        <pre id="admin-log" class="mono" style="white-space:pre-wrap; background:#f6f8fa; padding:12px; border-radius:8px; margin-top:10px; max-height:320px; overflow:auto;">（操作結果會顯示在這裡）</pre>
      </div>
    </section>
  </main>

  <script>
  // 用 sel() 避免與其他工具衝突
  const sel = (s, root=document) => root.querySelector(s);

  // --- 等待 shared-layout.js 初始化 sb（最多等 6 秒）---
  function waitForSB(cb, tries=60){
    if (window.sb) return cb();
    if (tries <= 0) return console.error('[admin-one-minutes] sb not ready');
    setTimeout(()=>waitForSB(cb, tries-1), 100);
  }

  // === 自動偵測「心聚 1 分鐘」表單檔案 ===
  const CANDIDATE_FORMS = ["one-minute.html", "mood.html", "one_minute.html"];
  function baseRoot(){ return location.origin + location.pathname.replace(/admin-one-minutes\.html.*/, ''); }
  async function fileExists(url){ try{ const r = await fetch(url,{method:'HEAD',cache:'no-store'}); return r.ok; }catch{return false;} }
  let detectedFormPath = null;
  async function detectFormPath(){
    const base = baseRoot();
    for (const name of CANDIDATE_FORMS) {
      if (await fileExists(base + name + '?_=' + Date.now())) { detectedFormPath = name; break; }
    }
    const badge = sel('#form-detect-badge');
    if (!badge) return;
    if (detectedFormPath) badge.innerHTML = `<span class="badge success">已偵測表單檔：${detectedFormPath}</span>`;
    else badge.innerHTML = `<span class="badge danger">找不到表單檔（請上傳 one-minute.html 或套新版 mood.html）</span>`;
  }

  // === 連結 & QR ===
  function buildLinks(courseId, sessionId){
    const base = baseRoot();
    const c = courseId ? `&course=${Number(courseId)}` : '';
    const s = sessionId ? `&session=${Number(sessionId)}` : '';
    const form = detectedFormPath || CANDIDATE_FORMS[0];
    return {
      pre : `${base}${form}?tp=pre${s}${c}`,
      post: `${base}${form}?tp=post${s}${c}`,
      h72 : `${base}${form}?tp=72h${s}${c}`,
    };
  }
  function renderAll(){
    const cid = sel('#course-input').value || sel('#course-select').value || '';
    const sid = sel('#session-input').value || '';
    const links = buildLinks(cid, sid);
    sel('#btn-pre').href  = links.pre;
    sel('#btn-post').href = links.post;
    sel('#btn-72h').href  = links.h72;
    sel('#url-pre').textContent  = links.pre;
    sel('#url-post').textContent = links.post;
    sel('#url-72h').textContent  = links.h72;
    sel('#qr-pre').innerHTML  = '';
    sel('#qr-post').innerHTML = '';
    sel('#qr-72h').innerHTML  = '';
    new QRCode(sel('#qr-pre'),  { text: links.pre,  width:128, height:128 });
    new QRCode(sel('#qr-post'), { text: links.post, width:128, height:128 });
    new QRCode(sel('#qr-72h'),  { text: links.h72,  width:128, height:128 });
  }
  function bindCopyButtons(){
    document.querySelectorAll('.btn.copy').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const text = sel(btn.getAttribute('data-copy')).textContent.trim();
        try{ await navigator.clipboard.writeText(text); btn.textContent='已複製'; setTimeout(()=>btn.textContent='複製連結',1200);}catch{alert('複製失敗，請手動複製');}
      });
    });
  }

  // === 用 sb 載入課程下拉（等 sb 好再叫） ===
  async function loadCourseOptions(){
    const { data, error } = await sb.from('courses')
      .select('id,title,category,published,deleted_at,created_at')
      .order('created_at',{ascending:false})
      .limit(50);
    if (error) throw error;
    const box = sel('#course-select');
    box.innerHTML = '<option value="">— 請選擇課程 —</option>';
    (data||[]).forEach(row=>{
      if (!(row.published && row.deleted_at==null)) return; // 受 RLS 影響，保留可見者
      const opt = document.createElement('option');
      opt.value = row.id;
      opt.textContent = `#${row.id}｜${row.title}（${row.category||"—"}）`;
      box.appendChild(opt);
    });
  }

  // === 測試課程工具（需 courses 寫入權限或後端代理） ===
  const log = (m)=>{ const el=sel('#admin-log'); el.textContent=(el.textContent?el.textContent+'\n':'')+m; };
  function bindAdminTools(){
    sel('#btn-create-course')?.addEventListener('click', async ()=>{
      try{
        const title = '【測試】園藝療癒體驗 ' + new Date().toLocaleString();
        const payload = { title, summary:'用來測心聚 1 分鐘表單流程', category:'horti', published:true };
        const { data, error } = await sb.from('courses').insert(payload).select('id,title,category,created_at').single();
        if (error) throw error;
        log('✅ 建立成功：id='+data.id+'｜'+data.title);
        sel('#course-input').value = data.id;
        sel('#course-select').value = '';
        renderAll();
        loadCourseOptions();
      }catch(e){ console.error(e); log('❌ 建立失敗：'+(e.message||e)); }
    });

    sel('#btn-list-course')?.addEventListener('click', async ()=>{
      try{
        const { data, error } = await sb.from('courses')
          .select('id,title,category,published,created_at')
          .ilike('title','【測試】%')
          .order('created_at',{ascending:false}).limit(20);
        if (error) throw error;
        if (!data?.length) return log('ℹ️ 查無【測試】課程。');
        log('📃 測試課程清單：\n'+data.map(r=>`- id=${r.id}｜${r.title}｜${r.category}｜${r.created_at}`).join('\n'));
      }catch(e){ console.error(e); log('❌ 查詢失敗：'+(e.message||e)); }
    });

    sel('#btn-clear-course')?.addEventListener('click', async ()=>{
      if(!confirm('確定要刪除所有「【測試】」開頭的課程嗎？')) return;
      try{
        const { data, error } = await sb.from('courses').delete().ilike('title','【測試】%').select('id');
        if (error) throw error;
        log('🗑️ 已刪除 '+(data?.length||0)+' 筆測試課程。');
        sel('#course-input').value=''; sel('#course-select').value='';
        renderAll(); loadCourseOptions();
      }catch(e){ console.error(e); log('❌ 刪除失敗：'+(e.message||e)); }
    });
  }

  // === 綁 UI ===
  function bindUI(){
    sel('#btn-refresh')?.addEventListener('click', renderAll);
    sel('#course-select')?.addEventListener('change', ()=>{ sel('#course-input').value = sel('#course-select').value || ''; renderAll(); });
    sel('#course-input')?.addEventListener('input', ()=>{ sel('#course-select').value=''; });
    sel('#session-input')?.addEventListener('input', renderAll);
    bindCopyButtons();
  }

  // === 初始化（關鍵：等 sb 準備好） ===
  waitForSB(async ()=>{
    try{
      await detectFormPath();     // 找出你實際的表單檔名
      await loadCourseOptions();  // 這裡才有 sb
      bindAdminTools();
      bindUI();
      renderAll();
    }catch(e){ console.error(e); }
  });
</script>

  
</body>
</html>
