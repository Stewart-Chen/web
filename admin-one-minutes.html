<!doctype html>
<html lang="zh-Hant" data-guard="checking">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é‡è¡¨ç·¨è¼¯ï½œHeartHub Studio å¿ƒèšåŠ</title>

  <!-- æ¨£å¼èˆ‡å­—å‹ï¼ˆæ¯”ç…§ admin.htmlï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    html[data-guard="checking"] main { visibility: hidden; }
    main.page-admin { padding-top: 14px; padding-bottom: 32px; }
    .admin-wrap { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:12px; }
    .admin-card { padding:16px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; box-shadow:var(--shadow-sm); }
    .grid2 { display:grid; grid-template-columns:repeat(2,minmax(220px,1fr)); gap:12px; }
    .grid3 { display:grid; grid-template-columns:repeat(3,minmax(180px,1fr)); gap:16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .wrap { word-break: break-all; }
    .btn.copy { padding:6px 10px; font-size:12px; }
    @media (max-width: 900px){ .admin-wrap { grid-template-columns:1fr; } }
  </style>

  <!-- SDK / å…±ç”¨è…³æœ¬ï¼ˆæ¯”ç…§ admin.htmlï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="js/shared-layout.js"></script>
  <script defer src="js/admin.js"></script>
  <script defer src="js/app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- å®ˆé–€ï¼šä½¿ç”¨ sbï¼ˆå’Œ admin.html ä¸€è‡´ï¼‰ -->
  <script defer>
    function waitForSB(cb, tries=60){
      if (window.sb) return cb();
      if (tries <= 0) return console.error('guard: sb not ready');
      setTimeout(()=>waitForSB(cb, tries-1), 100);
    }
    async function guardAdminPage() {
      try {
        const { data: userData } = await sb.auth.getUser();
        const user = userData?.user;
        if (!user) { location.replace('index.html?need_login=1'); return; }
        const { data, error } = await sb.from('admins').select('user_id').eq('user_id', user.id).maybeSingle();
        if (error || !data) { location.replace('index.html'); return; }
        document.documentElement.removeAttribute('data-guard');
      } catch (err) {
        console.error('guard error:', err);
        location.replace('index.html');
      }
    }
    waitForSB(guardAdminPage);
  </script>
</head>
<body>
  <!-- è‹¥ç¼º QRCodeï¼Œæä¾› no-opï¼ˆæ¯”ç…§ admin.html çš„å®¹éŒ¯ï¼‰ -->
  <script>
    if (typeof window.QRCode === 'undefined') {
      window.QRCode = function(){}; window.QRCode.CorrectLevel = {L:1,M:2,Q:3,H:4};
    }
  </script>

  <main class="container page-admin">
    <section class="admin-wrap">
      <!-- å·¦æ¬„ï¼šç”¢ç”Ÿè¡¨å–®é€£çµèˆ‡ QR -->
      <div class="admin-card">
        <h3 style="margin:0;">A. å¿ƒèš 1 åˆ†é˜è¡¨å–®é€£çµ / QR</h3>
        <p class="muted" style="margin-top:6px;">
          åŒä¸€æ”¯ <code class="mono">one-minute.html</code>ï¼Œä»¥ <code class="mono">tp=pre|post|72h</code> åˆ‡æ›èª²å‰/èª²å¾Œ/72hã€‚
          å…ˆé¸æ“‡ã€Œç¾æœ‰èª²ç¨‹ã€æˆ–æ‰‹å‹•è¼¸å…¥ idï¼Œå†æŒ‰ã€Œé‡æ–°æ•´ç†ã€ã€‚
        </p>

        <div class="grid2" style="margin-top:10px;">
          <label>é¸æ“‡èª²ç¨‹ï¼ˆæœ€è¿‘ 50 ç­†ï¼‰
            <select id="course-select">
              <option value="">â€” è«‹é¸æ“‡èª²ç¨‹ â€”</option>
            </select>
          </label>

          <label>æˆ–æ‰‹å‹•è¼¸å…¥èª²ç¨‹ ID
            <input id="course-input" type="number" placeholder="ä¾‹å¦‚ 55" />
          </label>

          <label>å ´æ¬¡ç·¨è™Ÿï¼ˆsessionï¼Œå¯ç©ºï¼‰
            <input id="session-input" type="number" placeholder="ä¾‹å¦‚ 101" />
          </label>

          <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
            <button id="btn-refresh" class="btn">é‡æ–°æ•´ç†é€£çµèˆ‡ QR</button>
          </div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <a id="btn-pre"  class="btn">èª²å‰è¡¨å–®</a>
          <a id="btn-post" class="btn secondary">èª²å¾Œè¡¨å–®</a>
          <a id="btn-72h"  class="btn outline">72 å°æ™‚è¿½è¹¤</a>
        </div>

        <div class="grid3" style="margin-top:12px;">
          <div>
            <div id="qr-pre"></div>
            <p id="url-pre"  class="muted wrap mono">â€”</p>
            <button class="btn copy" data-copy="#url-pre">è¤‡è£½é€£çµ</button>
          </div>
          <div>
            <div id="qr-post"></div>
            <p id="url-post" class="muted wrap mono">â€”</p>
            <button class="btn copy" data-copy="#url-post">è¤‡è£½é€£çµ</button>
          </div>
          <div>
            <div id="qr-72h"></div>
            <p id="url-72h" class="muted wrap mono">â€”</p>
            <button class="btn copy" data-copy="#url-72h">è¤‡è£½é€£çµ</button>
          </div>
        </div>

        <p class="muted" style="margin-top:8px;">
          <small>æç¤ºï¼šè‹¥ <code class="mono">course</code> ç•™ç©ºï¼Œé€£çµä»å¯é–‹å•Ÿé é¢ï¼Œä½†è‹¥ <code class="mono">one_minute.course_id</code> è¨­æœ‰å¤–éµï¼Œå¯«å…¥æœƒå¤±æ•—ã€‚å»ºè­°ç¸½æ˜¯å¸¶å…¥å­˜åœ¨çš„èª²ç¨‹ idã€‚</small>
        </p>
      </div>

      <!-- å³æ¬„ï¼šæ¸¬è©¦èª²ç¨‹å·¥å…· -->
      <div class="admin-card">
        <h3 style="margin:0;">B. æ¸¬è©¦èª²ç¨‹å·¥å…·ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰</h3>
        <p class="muted" style="margin-top:6px;">
          å¿«é€Ÿå»ºç«‹ä¸€ç­†ã€æ¸¬è©¦ã€‘èª²ç¨‹ï¼ˆcategoryï¼š<span class="mono">horti</span>ï¼‰ï¼Œæˆ–æŸ¥è©¢ï¼æ¸…é™¤ã€‚
          éœ€è¦ RLS å…è¨±ç›®å‰ç™»å…¥è€…å¯å° <code class="mono">public.courses</code> é€²è¡Œ <em>insert/delete/select</em>ã€‚
        </p>

        <div class="actions" style="margin-top:8px;">
          <button id="btn-create-course" class="btn">å»ºç«‹æ¸¬è©¦èª²ç¨‹</button>
          <button id="btn-list-course" class="btn secondary">æŸ¥è©¢æ¸¬è©¦èª²ç¨‹</button>
          <button id="btn-clear-course" class="btn danger">æ¸…é™¤æ¸¬è©¦èª²ç¨‹</button>
        </div>

        <pre id="admin-log" class="mono" style="white-space:pre-wrap; background:#f6f8fa; padding:12px; border-radius:8px; margin-top:10px; max-height:320px; overflow:auto;">ï¼ˆæ“ä½œçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰</pre>
      </div>
    </section>
  </main>

  <script>
  // ç”¨ sel() é¿å…èˆ‡å…¶ä»–å·¥å…·è¡çª
  const sel = (s, root=document) => root.querySelector(s);

  // --- ç­‰å¾… shared-layout.js åˆå§‹åŒ– sbï¼ˆæœ€å¤šç­‰ 6 ç§’ï¼‰---
  function waitForSB(cb, tries=60){
    if (window.sb) return cb();
    if (tries <= 0) return console.error('[admin-one-minutes] sb not ready');
    setTimeout(()=>waitForSB(cb, tries-1), 100);
  }

  // === è‡ªå‹•åµæ¸¬ã€Œå¿ƒèš 1 åˆ†é˜ã€è¡¨å–®æª”æ¡ˆ ===
  const CANDIDATE_FORMS = ["one-minute.html", "mood.html", "one_minute.html"];
  function baseRoot(){ return location.origin + location.pathname.replace(/admin-one-minutes\.html.*/, ''); }
  async function fileExists(url){ try{ const r = await fetch(url,{method:'HEAD',cache:'no-store'}); return r.ok; }catch{return false;} }
  let detectedFormPath = null;
  async function detectFormPath(){
    const base = baseRoot();
    for (const name of CANDIDATE_FORMS) {
      if (await fileExists(base + name + '?_=' + Date.now())) { detectedFormPath = name; break; }
    }
    const badge = sel('#form-detect-badge');
    if (!badge) return;
    if (detectedFormPath) badge.innerHTML = `<span class="badge success">å·²åµæ¸¬è¡¨å–®æª”ï¼š${detectedFormPath}</span>`;
    else badge.innerHTML = `<span class="badge danger">æ‰¾ä¸åˆ°è¡¨å–®æª”ï¼ˆè«‹ä¸Šå‚³ one-minute.html æˆ–å¥—æ–°ç‰ˆ mood.htmlï¼‰</span>`;
  }

  // === é€£çµ & QR ===
  function buildLinks(courseId, sessionId){
    const base = baseRoot();
    const c = courseId ? `&course=${Number(courseId)}` : '';
    const s = sessionId ? `&session=${Number(sessionId)}` : '';
    const form = detectedFormPath || CANDIDATE_FORMS[0];
    return {
      pre : `${base}${form}?tp=pre${s}${c}`,
      post: `${base}${form}?tp=post${s}${c}`,
      h72 : `${base}${form}?tp=72h${s}${c}`,
    };
  }
  function renderAll(){
    const cid = sel('#course-input').value || sel('#course-select').value || '';
    const sid = sel('#session-input').value || '';
    const links = buildLinks(cid, sid);
    sel('#btn-pre').href  = links.pre;
    sel('#btn-post').href = links.post;
    sel('#btn-72h').href  = links.h72;
    sel('#url-pre').textContent  = links.pre;
    sel('#url-post').textContent = links.post;
    sel('#url-72h').textContent  = links.h72;
    sel('#qr-pre').innerHTML  = '';
    sel('#qr-post').innerHTML = '';
    sel('#qr-72h').innerHTML  = '';
    new QRCode(sel('#qr-pre'),  { text: links.pre,  width:128, height:128 });
    new QRCode(sel('#qr-post'), { text: links.post, width:128, height:128 });
    new QRCode(sel('#qr-72h'),  { text: links.h72,  width:128, height:128 });
  }
  function bindCopyButtons(){
    document.querySelectorAll('.btn.copy').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const text = sel(btn.getAttribute('data-copy')).textContent.trim();
        try{ await navigator.clipboard.writeText(text); btn.textContent='å·²è¤‡è£½'; setTimeout(()=>btn.textContent='è¤‡è£½é€£çµ',1200);}catch{alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');}
      });
    });
  }

  // === ç”¨ sb è¼‰å…¥èª²ç¨‹ä¸‹æ‹‰ï¼ˆç­‰ sb å¥½å†å«ï¼‰ ===
  async function loadCourseOptions(){
    const { data, error } = await sb.from('courses')
      .select('id,title,category,published,deleted_at,created_at')
      .order('created_at',{ascending:false})
      .limit(50);
    if (error) throw error;
    const box = sel('#course-select');
    box.innerHTML = '<option value="">â€” è«‹é¸æ“‡èª²ç¨‹ â€”</option>';
    (data||[]).forEach(row=>{
      if (!(row.published && row.deleted_at==null)) return; // å— RLS å½±éŸ¿ï¼Œä¿ç•™å¯è¦‹è€…
      const opt = document.createElement('option');
      opt.value = row.id;
      opt.textContent = `#${row.id}ï½œ${row.title}ï¼ˆ${row.category||"â€”"}ï¼‰`;
      box.appendChild(opt);
    });
  }

  // === æ¸¬è©¦èª²ç¨‹å·¥å…·ï¼ˆéœ€ courses å¯«å…¥æ¬Šé™æˆ–å¾Œç«¯ä»£ç†ï¼‰ ===
  const log = (m)=>{ const el=sel('#admin-log'); el.textContent=(el.textContent?el.textContent+'\n':'')+m; };
  function bindAdminTools(){
    sel('#btn-create-course')?.addEventListener('click', async ()=>{
      try{
        const title = 'ã€æ¸¬è©¦ã€‘åœ’è—ç™‚ç™’é«”é©— ' + new Date().toLocaleString();
        const payload = { title, summary:'ç”¨ä¾†æ¸¬å¿ƒèš 1 åˆ†é˜è¡¨å–®æµç¨‹', category:'horti', published:true };
        const { data, error } = await sb.from('courses').insert(payload).select('id,title,category,created_at').single();
        if (error) throw error;
        log('âœ… å»ºç«‹æˆåŠŸï¼šid='+data.id+'ï½œ'+data.title);
        sel('#course-input').value = data.id;
        sel('#course-select').value = '';
        renderAll();
        loadCourseOptions();
      }catch(e){ console.error(e); log('âŒ å»ºç«‹å¤±æ•—ï¼š'+(e.message||e)); }
    });

    sel('#btn-list-course')?.addEventListener('click', async ()=>{
      try{
        const { data, error } = await sb.from('courses')
          .select('id,title,category,published,created_at')
          .ilike('title','ã€æ¸¬è©¦ã€‘%')
          .order('created_at',{ascending:false}).limit(20);
        if (error) throw error;
        if (!data?.length) return log('â„¹ï¸ æŸ¥ç„¡ã€æ¸¬è©¦ã€‘èª²ç¨‹ã€‚');
        log('ğŸ“ƒ æ¸¬è©¦èª²ç¨‹æ¸…å–®ï¼š\n'+data.map(r=>`- id=${r.id}ï½œ${r.title}ï½œ${r.category}ï½œ${r.created_at}`).join('\n'));
      }catch(e){ console.error(e); log('âŒ æŸ¥è©¢å¤±æ•—ï¼š'+(e.message||e)); }
    });

    sel('#btn-clear-course')?.addEventListener('click', async ()=>{
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ã€Œã€æ¸¬è©¦ã€‘ã€é–‹é ­çš„èª²ç¨‹å—ï¼Ÿ')) return;
      try{
        const { data, error } = await sb.from('courses').delete().ilike('title','ã€æ¸¬è©¦ã€‘%').select('id');
        if (error) throw error;
        log('ğŸ—‘ï¸ å·²åˆªé™¤ '+(data?.length||0)+' ç­†æ¸¬è©¦èª²ç¨‹ã€‚');
        sel('#course-input').value=''; sel('#course-select').value='';
        renderAll(); loadCourseOptions();
      }catch(e){ console.error(e); log('âŒ åˆªé™¤å¤±æ•—ï¼š'+(e.message||e)); }
    });
  }

  // === ç¶ UI ===
  function bindUI(){
    sel('#btn-refresh')?.addEventListener('click', renderAll);
    sel('#course-select')?.addEventListener('change', ()=>{ sel('#course-input').value = sel('#course-select').value || ''; renderAll(); });
    sel('#course-input')?.addEventListener('input', ()=>{ sel('#course-select').value=''; });
    sel('#session-input')?.addEventListener('input', renderAll);
    bindCopyButtons();
  }

  // === åˆå§‹åŒ–ï¼ˆé—œéµï¼šç­‰ sb æº–å‚™å¥½ï¼‰ ===
  waitForSB(async ()=>{
    try{
      await detectFormPath();     // æ‰¾å‡ºä½ å¯¦éš›çš„è¡¨å–®æª”å
      await loadCourseOptions();  // é€™è£¡æ‰æœ‰ sb
      bindAdminTools();
      bindUI();
      renderAll();
    }catch(e){ console.error(e); }
  });
</script>

  
</body>
</html>
